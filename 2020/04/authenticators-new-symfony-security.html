<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Meet the new Symfony Security: Authenticators ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css?v1">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96>
    <link rel="me" href="https://phpc.social/@wouterj"><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta content="Meet the new Symfony Security: Authenticators" property="og:title">
      <meta content="article" property="og:type">
      <meta content="After more than half a year of work and discussions, Symfony 5.1 ships
with an experimental and revisited Security system. I’m incredibly
excited about this system, as I think it opens up the component for a
lot of possibilities. That’s why in the coming week, I’ll publish a
series of blogposts about this new system. I hope you’ll be just as
excited as I am and help realising the full potential with us!

" property="og:description">
      <meta content="2020-04-28T00:00:00+00:00" property="article:published_time">
      <meta content="https://wouterj.nl/2020/04/authenticators-new-symfony-security" property="og:url">
      <meta content="https://wouterj.nl/img/og/authenticators-new-symfony-security.png?1" property="og:image">
    <script>if(!sessionStorage.getItem("_swa")){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer.indexOf(location.protocol+"//"+location.host)!==0?document.referrer:'',screen:screen.width+"x"+screen.height,user:"wouterj",utcoffset:"2"}),{referrerPolicy:"no-referrer-when-downgrade"})};sessionStorage.setItem("_swa","1");</script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav"><li class="nav__item  "><a href="/oss-list"><span class="button__text">Contribute to Open Source</span></a></li></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    
        <span class="post__category">
        <time class="dt-published" datetime="2020-04-28T00:00:00+00:00" itemprop="datePublished">
            APR '20
        </time>
        
        
        &#xf139;
        
        </span>
    

    <h1 class="post__heading" itemprop="headline">Meet the new Symfony Security: Authenticators</h1>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>After more than half a year of work and discussions, Symfony 5.1 ships
with an experimental and revisited Security system. I’m incredibly
excited about this system, as I think it opens up the component for a
lot of possibilities. That’s why in the coming week, I’ll publish a
series of blogposts about this new system. I hope you’ll be just as
excited as I am and help realising the full potential with us!</p></div><div class="post__entry">

<aside class="side" data-type="Try it yourself!">
  <p>If you’re using Symfony 5.1, the SecurityBundle comes with all tools you
need! Set <code class="highlighter-shiki">security.enable_authenticator_manager</code> to <code class="highlighter-shiki">true</code> to enable the
new system!</p>

  <p>Please be aware that this new system in experimental. It may contain
backwards compatibility breaks in 5.2. However, I don’t like to ruin the
life of early-testers so we keep this to the bare minimum. Please give it
a go and report any suggestions, problems, bugs, leaks or whatever!</p>
</aside>

<p>So… what is so different about this new system? It would like to
summarize it in three topics:</p>

<ul>
  <li><a href="#removed-everything-but-guards">It removes everything but Guard</a></li>
  <li><a href="#moved-to-an-event-based-system">It refactored to an event-based System</a></li>
  <li><a href="#the-next-generation-of-guards">It introduces the next generation of Guards</a></li>
</ul>
      <h2 id="removed-everything-but-guards">
        
        
          <a href="#removed-everything-but-guards" class="section-link"></a> Removed everything but Guards
        
        
      </h2>

<p>Since Symfony 2.0, the authentication system of Symfony can be drawn
like this:</p>

<p><img src="/img/security2-providers-listeners.png" alt="Symfony Security" /></p>

<p>This diagram has set-up 2 firewalls (yellow and red). The yellow
firewall has 2 different ways to authenticate (e.g. login form and json
login) and the red firewall has one way to authenticate (e.g. JWT).</p>

<p>A <em>firewall listener</em> extracts all necessary information from the
request (e.g. username, password, csrf token). This is passed into a
global <em>authentication manager</em>, which then calls the required
<em>authentication provider</em> (e.g. one that can authenticate a username and
password).</p>

<p>If you were to write your own custom authentication, you would most
likely need to provide a custom <em>listener</em>. This listener needs to do
all stuff: calling the manager, storing the authenticated token, setting
up the session (e.g. migrating it) and creating a correct response. It’s
very easy to forget a step, resulting in a less secure or broken
authentication. Hence, if you look at Symfony’s own firewall listeners,
you can find minor inconsistencies as well.</p>

<p>The new authenticator system can be drawn like this:</p>

<p><img src="/img/security2-authenticators.png" alt="Symfony Authenticators" /></p>

<ol>
  <li>There is <em>only one</em> listener, provided by Symfony, that passes the
request into an authenticator manager</li>
  <li>There is <em>one</em> authenticator manager per firewall. This manager calls
the correct authenticator, which authenticates the request and
returns a response</li>
</ol>

<p>You now only need to write a custom authenticator. The authenticator
manager (maintained by Symfony) takes care of session management,
storing the token, remember me functionality, etc. So there are less
things to forget!</p>

<p>This may appear to be similar to Guards in the current system… It is!
However, the internal logics of the component was still using the
listeners and providers. This new system makes them all use exactly the
same interface: Authenticators. This makes it easier to understand and
contribute to the Security component.</p>

<p>As there now is one authenticator manager per firewall, the manager
knows how to authenticate a request and return a success response. <strong>This
also allowed us to add programmatic login to Symfony</strong>: The manager is
now finally able to authenticate a User object and return a success
response.</p>
    
      <h2 id="moved-to-an-event-based-system">
        
        
          <a href="#moved-to-an-event-based-system" class="section-link"></a> Moved to an Event-based System
        
        
      </h2>

<p>Symfony’s HttpKernel component is built around
<a href="https://symfony.com/doc/current/components/http_kernel.html#httpkernel-driven-by-events">5 kernel events</a>.
Listeners to these events execute the core process of Symfony: finding a
controller, executing that controller and handling the response. You can
also create your own event listeners on these events, so you can
completely customize and extend this core process.</p>

<aside class="side" data-type="Here's how you can help">
  <p>I can imagine Symfony providing a <em>login throttling listener</em>, which
blocks login for a couple of minutes after too many failed attempts.</p>

  <p>Or e.g. a monolog logger to log failed attempts (such that you can
analyse them and block misbehaving IPs or the like).</p>

  <p>You can probably come up with even better ideas of listeners! Please
contribute them to Symfony.</p>
</aside>

<p>Up to now, the Security component didn’t use events for this purpose.
This made many parts of the component quite hard to extend or customize.
That’s why this new system is built around 3 main events:</p>

<dl>
  <dt><code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code></dt>
  <dd>This is the most important event. Its listeners validate any
credentials returned from the authenticator (e.g. a password or CSRF
token).</dd>
  <dt><code class="highlighter-shiki">LoginSuccessEvent</code></dt>
  <dd>If all credentials were valid, this event is dispatched. The core
system uses this to e.g. create a remember me cookie or upgrade the
password hash.</dd>
  <dt><code class="highlighter-shiki">LoginFailureEvent</code></dt>
  <dd>If there was an error or credentials are not correct, this event is
dispatched.</dd>
</dl>

<p>All core logic is now executed as listener on these events. E.g. if an
authenticator requires a password to be validated, a listener on
<code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code> will do this for you. Things like
user checkers, session strategies, remember me cookies, password
upgrading are all done inside event listeners.</p>
    
      <h2 id="the-next-generation-of-guards">
        
        
          <a href="#the-next-generation-of-guards" class="section-link"></a> The Next Generation of Guards
        
        
      </h2>

<aside class="side" data-type="Here's how you can help">
  <p>It would be lovely to have many more modern authenticators inside
Symfony core:</p>

  <ul>
    <li>Third-party/redirections: SAML, OAuth, …</li>
    <li>API tokens: JWT, JOSE, PASETO, Windows Identity Foundation, …</li>
    <li>“Magic links” sent via Notifier component</li>
  </ul>
</aside>

<p>A few years ago,
<a href="https://symfonycasts.com/blog/guard-authentication">Guards</a> where
introduced to provide a better extension point for Security. The new
system started with this exact Guard interface as a base. The event
based logic introduced a centralized credentials checking. This removed
the need for a <code class="highlighter-shiki">checkCredentials()</code> method in the Guard interface. Later
on, we introduced some more changes to the interface: The next generation
<code class="highlighter-shiki">AuthenticatorInterface</code> was born!</p>

<p>The big change from the Guard interface you may know is that
<code class="highlighter-shiki">getCredentials()</code> and <code class="highlighter-shiki">getUser()</code> are merged into one method:
<code class="highlighter-shiki">authenticate(Request $request)</code>. And, as mentioned before,
<code class="highlighter-shiki">checkCredentials()</code> is gone.</p>

<p>This new <code class="highlighter-shiki">authenticate()</code> method creates a <em>Security Passport</em>. This is
a new concept in authenticators. <strong>A passport contains the user and any
credentials needed to authenticate.</strong> This extra information is provided
using <em>Passport Badges</em>. Listeners on the
<code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code> will validate and check the
passport and all its badges. If <em>all</em> badges are resolved, the user is
succesfully authenticated.</p>

<p>Let’s see the passport in action. Assume we’re building a form login:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">HttpFoundation</span><span style="color: #999999">\</span><span style="color: #C7C8D2">Request</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Exception</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UsernameNotFoundException</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AuthenticatorInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Badge</span><span style="color: #999999">\</span><span style="color: #C7C8D2">CsrfTokenBadge</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Credentials</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PasswordCredentials</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #C7C8D2">Passport</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="8"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PassportInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="9"></span>
<span class="line" data-linenr="10"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">FormAuthenticator</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AuthenticatorInterface</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="12"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="13"></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">authenticate</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Request</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #999999">)</span><span style="color: #E5673D">:</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PassportInterface</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="16"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// find a user based on an &quot;email&quot; form field</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">userRepository</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">findOneByEmail</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">email</span><span style="color: #999999">&#39;</span><span style="color: #999999">))</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">!$</span><span style="color: #D8DEE9">user</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">throw</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UsernameNotFoundException</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="21"></span>
<span class="line" data-linenr="22"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// return the Security passport</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Passport</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// add the user we&#39;ve just found</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="26"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// add credentials from the &quot;password&quot; form field</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PasswordCredentials</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #999999">)),</span></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">            </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="29"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic">// and CSRF protection using a &quot;csrf_token&quot; field</span></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">CsrfTokenBadge</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">loginform</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">csrf_token</span><span style="color: #999999">&#39;</span><span style="color: #999999">))</span></span>
<span class="line" data-linenr="31"></span>
<span class="line" data-linenr="32"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic">// and add support for upgrading the password hash</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PasswordUpgradeBadge</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="34"><span style="color: #BBBBBB">                    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">                    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">userRepository</span></span>
<span class="line" data-linenr="36"><span style="color: #BBBBBB">                </span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">            </span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="38"><span style="color: #BBBBBB">        </span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="39"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="40"><span style="color: #999999">}</span></span></code></pre>
</div>

<aside class="side" data-type="Here's how you can help">
  <p>I’ve talked before on <a href="/2019/03/security-removing-user">removing the User object from Security</a>.
The main passport interface does not require a user. I invite anyone to
build a system that works without user and submit it to Symfony.</p>
</aside>

<p>This gives an authenticator all power about what is needed for
successful authentication. At the same time, the most important piece is
handled centralized in an event listener. This makes applications less
vunerable, as security leaks will be fixed by the Symfony Security
team. You can also write your own listener to resolve a badge before a
listener of Symfony, to customize the checks.</p>

<p>There also is a <code class="highlighter-shiki">CustomCredentials</code> class that you can use to call a
custom method to check credentials and a <code class="highlighter-shiki">SelfCheckingPassport</code> in case
you don’t need Symfony to check any credentials (e.g. when using API tokens).</p>
    
      <h2 id="next-up">
        
        
          <a href="#next-up" class="section-link"></a> Next up
        
        
      </h2>

<p>I plan to write at least two more blogposts about the new system in the
coming weeks. We’ll write real code for a real custom logins on both of these:</p>

<ul>
  <li>Writing a custom authenticator: Passwords &amp; Badges</li>
  <li>Customizing security using event listeners</li>
</ul>

        </div>
    </div>
</article>

    </div><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2023 Wouter de Jong</p>
</footer>
</body>

</html>
