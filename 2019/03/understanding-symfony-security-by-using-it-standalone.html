<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Understanding Symfony Security by Using it Standalone ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css?v1">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96>
    <link rel="me" href="https://phpc.social/@wouterj"><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta content="Understanding Symfony Security by Using it Standalone" property="og:title">
      <meta content="article" property="og:type">
      <meta content="Setting up big Symfony components in a blank PHP project helps a lot to
understand it. You’ll grasp the main architecture of the component much easier
this way. Let’s try to understand Symfony Security by doing exactly this!

" property="og:description">
      <meta content="2019-03-20T00:00:00+00:00" property="article:published_time">
      <meta content="https://wouterj.nl/2019/03/understanding-symfony-security-by-using-it-standalone" property="og:url">
      <meta content="https://wouterj.nl/img/og/understanding-symfony-security-by-using-it-standalone.png?1" property="og:image">
    <script src="https://cdn.counter.dev/script.js" data-id="07663ec4-bb0d-40fb-ad71-e7b091c17341" data-utcoffset="1"></script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav"><li class="nav__item  "><a href="/oss-list"><span class="button__text">Contribute to Open Source</span></a></li></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    
        <span class="post__category">
        <time class="dt-published" datetime="2019-03-20T00:00:00+00:00" itemprop="datePublished">
            MAR '19
        </time>
        
        
        &#xf139;
        
        </span>
    

    <h1 class="post__heading" itemprop="headline">Understanding Symfony Security by Using it Standalone</h1>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>Setting up big Symfony components in a blank PHP project helps a lot to
understand it. You’ll grasp the main architecture of the component much easier
this way. Let’s try to understand Symfony Security by doing exactly this!</p></div><div class="post__entry">
      <h2 id="security-101">
        
        
          <a href="#security-101" class="section-link"></a> Security 101
        
        
      </h2>

<p>On almost all platforms, security consists of two phases: Authentication and
Authorization. Let’s quickly discuss them before digging deep into Symfony
security:</p>

<p><img src="/img/security-phases.png" alt="Authentication and Authorization" /></p>

<ol>
  <li><strong>Who are you?</strong> is the main question of <em>Authentication</em>. Every HTTP request
again, we have to find out who the requester is. At first visit to a site,
this is usually a login form. A second request often uses a session stored
after logging in to find out who you are. An API call often uses API tokens</li>
  <li><strong>Are you allowed to do this?</strong> is the question answered during
<em>Authorization</em>. Every request involves an action. For instance, you are
reading this blog article, I’m editing it at the moment, over 10 years I’ll
probably delete it, etc. During authorization, we find out if the person
identified in (1) is allowed to do the action he wants to do</li>
</ol>
    
      <h2 id="set-up-our-blank-project">
        
        
          <a href="#set-up-our-blank-project" class="section-link"></a> Set-up our Blank Project
        
        
      </h2>

<aside class="side" data-type="example">
  <p>The final project of this blogpost can be found at
<a href="https://github.com/wouterj-nl/security-standalone">github</a>.</p>
</aside>

<p>Setting up a blank project is nothing more than creating a new directory. In
the directory, we’ll use <a href="https://getcomposer.org/">Composer</a> to install the
Security Core component:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ mkdir security-101</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">$ </span><span style="color: #C7C8D2">cd</span><span style="color: #BBBBBB"> security-101</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">$ composer require symfony/security-core</span></span></code></pre>
</div>

<p>Security contains a couple sub components: Core, Http, Guard, Csrf. In this
post, we’ll focus on the core only. In a funny plot twist, you’ll directly
discover what HTTP is doing if you’re reading the side notes!</p>
    
      <h2 id="authentication-input-the-token">
        
        
          <a href="#authentication-input-the-token" class="section-link"></a> Authentication Input: The token
        
        
      </h2>

<p>The question “who are you?” can only be answered if we have input from the user
world (there must be a “you”). This input can be anything. As already
explained, the values of the login form upon login is one example of this
input. In all requests after the user logged in, a browser session represents
the input from user world.</p>

<aside class="side" data-type="Symfony internals">
  <p>The HTTP Security component uses listeners attached to
<a href="https://symfony.com/doc/current/reference/events.html#kernel-request"><code class="highlighter-shiki">kernel.request</code></a>
to create tokens. For instance, the
<a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/UsernamePasswordFormAuthenticationListener.php"><code class="highlighter-shiki">UsernamePasswordFormAuthenticationListener</code></a>
creates a <code class="highlighter-shiki">UsernamePasswordToken</code> based on the login form submit.</p>
</aside>

<p>As our goal is just to write one working PHP file, we’ll use static strings as
“input from the user”:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">&lt;?</span><span style="color: #BBBBBB">php </span><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">require_once</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">vendor/autoload.php</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Token</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UsernamePasswordToken</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UsernamePasswordToken</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">default</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>This type of token is most often used in traditional applications, it holds a
username and a password (ignore that third argument for the moment). Other
tokens are for instance a <code class="highlighter-shiki">RememberMeToken</code>, which uses a browser cookie, or
you can create an <code class="highlighter-shiki">BearerToken</code> that contains a header used for API requests.</p>
    
      <h3 id="lets-authenticate-the-token-meet-the-authenticationmanager">
        
        
          <a href="#lets-authenticate-the-token-meet-the-authenticationmanager" class="section-link"></a> Let’s Authenticate the Token: Meet the AuthenticationManager
        
        
      </h3>

<p>Now we have the token representing the user input, it’s time to authenticate
it. The Security component provides an <code class="highlighter-shiki">AuthenticationManagerInterface</code> for this.
By default, only one implementation of this interface is provided: The
<code class="highlighter-shiki">AuthenticationProviderManager</code>. Its name is quite confusing, it’s not managing
<em>authentication providers</em>, but it is the <em>authentication manager</em> based on
<em>authentication providers</em>.</p>

<p><code class="highlighter-shiki">AuthenticationProviderInterface</code> classes do the hard work for this manager:
They transform an unauthenticated token into an authenticated token. In other
words, they transform user input into a security identity.</p>

<aside class="side" data-type="Symfony internals">
  <p><a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/Authentication/Provider">Other authentication providers</a>
are for instance a <code class="highlighter-shiki">RememberMeAuthenticationProvider</code> (authenticating a remember-me
cookie) and an <code class="highlighter-shiki">AnonymousAuthenticationProvider</code> (which always returns a token
representing an anonymous user).</p>
</aside>

<p>The most commonly used provider is the <code class="highlighter-shiki">DaoAuthenticationProvider</code> (<strong>D</strong>ata
<strong>A</strong>ccess <strong>O</strong>bject). It uses a <em>user provider</em> to find a user matching the
input from somewhere and then matches the password (using a <em>password encoder</em>).</p>
    
      <h3 id="set-up-some-user-resources-the-userprovider">
        
        
          <a href="#set-up-some-user-resources-the-userprovider" class="section-link"></a> Set-up some User Resources: The UserProvider
        
        
      </h3>

<p>To get things working, we first define a class able to load users from “some
resource”. In this case, we use the <code class="highlighter-shiki">InMemoryUserProvider</code> that fetches users
from a PHP array.</p>

<aside class="side" data-type="Symfony internals">
  <p><a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/User">Other user providers</a>
load users from a database or LDAP servers.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">InMemoryUserProvider</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">InMemoryUserProvider</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">roles</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_SUPERVISOR</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">],</span></span>
<span class="line" data-linenr="10"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// As an example of this class, let&#39;s find the user:</span></span>
<span class="line" data-linenr="13"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">wouterUser</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">loadUserByUsername</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>
    
      <h3 id="safety-first-encrypted-user-passwords">
        
        
          <a href="#safety-first-encrypted-user-passwords" class="section-link"></a> Safety first: Encrypted User Passwords
        
        
      </h3>

<p>Saving plain texts passwords is a no-go for web applications. They are often
encoded using for instance bcrypt or sha256. This is abstracted in <em>password
encoders</em>. They are able to encode a plain text password and check whether the
password entered by the user was valid:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Encoder</span><span style="color: #999999">\</span><span style="color: #C7C8D2">EncoderFactory</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Encoder</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PlaintextPasswordEncoder</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">EncoderFactory</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// we take the easiest road: plain text passwords</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">::class</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PlaintextPasswordEncoder</span><span style="color: #999999">(),</span></span>
<span class="line" data-linenr="10"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// First, get the encoder associated with our user (other users</span></span>
<span class="line" data-linenr="13"><span style="color: #6B90C0; font-style: italic">// can use other encoders).</span></span>
<span class="line" data-linenr="14"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getEncoder</span><span style="color: #999999">(</span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">::class</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="15"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// Then, check whether some input matches our user&#39;s password:</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">isPasswordValid</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">wouterUser</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getPassword</span><span style="color: #999999">(),</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>
    
      <h3 id="instantiating-the-authentication-manager">
        
        
          <a href="#instantiating-the-authentication-manager" class="section-link"></a> Instantiating the Authentication Manager
        
        
      </h3>

<p>Yay, it took quite some effort, but we’re ready to create the
<code class="highlighter-shiki">AuthenticationProviderManager</code>!</p>

<aside class="side" data-type="Symfony internals">
  <p>If you look closely, the <code class="highlighter-shiki">&#39;default&#39;</code> string is equal to the one provided in the
token: This is the <em>provider key</em>. It is used to make sure the token is from
our application and also to know which provided should handle the token
(multiple providers might be able to handle a <code class="highlighter-shiki">UsernamePasswordToken</code>).</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AuthenticationProviderManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Provider</span><span style="color: #999999">\</span><span style="color: #C7C8D2">DaoAuthenticationProvider</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UserChecker</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticationManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AuthenticationProviderManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">DaoAuthenticationProvider</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserChecker</span><span style="color: #999999">(),</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">default</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="14"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>As you see, there is one more class: The <code class="highlighter-shiki">UserChecker</code>. It checks some “user
flags” after it is fetched from the user provider. This includes for instance
whether the user is activated, banned, etc.</p>
    
      <h3 id="authenticating-the-token">
        
        
          <a href="#authenticating-the-token" class="section-link"></a> Authenticating the Token
        
        
      </h3>

<aside class="side" data-type="Symfony internals">
  <p>The firewall listeners of Http security also call the authenticate method
directly. See for instance the
<a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/UsernamePasswordFormAuthenticationListener.php#L100"><code class="highlighter-shiki">UsernamePasswordFormAuthenticationListener</code></a>.</p>
</aside>

<p>Finally – we’re more than halfway the post now – we are able to authenticate
the token we created:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticationManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">authenticate</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">inputToken</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">echo</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">Hello </span><span style="color: #999999">&#39;</span><span style="color: #E5673D">.</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getUsername</span><span style="color: #999999">()</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">!</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span></code></pre>
</div>
    
      <h2 id="authorize-actions-the-accessdecisionmanager">
        
        
          <a href="#authorize-actions-the-accessdecisionmanager" class="section-link"></a> Authorize Actions: The AccessDecisionManager
        
        
      </h2>

<aside class="side" data-type="Symfony internals">
  <p>Symfony security started as a direct port of JAVA’s <a href="https://spring.io/projects/spring-security">Spring
Security</a>. This is why the naming
is often quite different from the rest of Symfony. It however, gives you two
documentations to understand Security!</p>
</aside>

<p>Now we’ve authenticated the user input and the Security system validated our
input, it’s time to answer the <em>Are you allowe to do this?</em> question. Let me
introduce you to yet another “manager”: <code class="highlighter-shiki">AccessDecisionManagerInterface</code>.</p>

<p>The default implementation uses “Security voters” to decide whether the user is
allowed to execute an action. These voters are provided with an <em>attribute</em>
(representing the action) and optionally some context (i.e. the subject of the
action).</p>

<aside class="side" data-type="Symfony internals">
  <p>In the Http component, an <a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/AccessListener.php"><code class="highlighter-shiki">AccessListener</code></a>
checks access using this manager based on the configured <code class="highlighter-shiki">access_control</code>
rules.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authorization</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ... voters</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>The default voters of Symfony are a bit strange, they don’t validate an action,
but validate the user’s identity. One of them is the <code class="highlighter-shiki">RoleVoter</code>. It checks
whether <code class="highlighter-shiki">User#getRoles()</code> contains the provided attribute:</p>

<aside class="side" data-type="Symfony internals">
  <p>A <code class="highlighter-shiki">RoleHierarchyVoter</code> is also provided, which understands hierarchies in
roles (i.e. “admin is a user”). <a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/Authorization/Voter">Another default voter</a>
is the <code class="highlighter-shiki">AuthenticatedVoter</code>, which checks if the token is fully authenticated,
anonymous, etc.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authorization</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Voter</span><span style="color: #999999">\</span><span style="color: #C7C8D2">RoleVoter</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// TITLE_ is the prefix an attribute must have in order to be</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// managed by this voter</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">RoleVoter</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_</span><span style="color: #999999">&#39;</span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="9"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #6B90C0; font-style: italic">// now we can use the access decision manager to see if the</span></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// authenticated token has the &quot;supervisor&quot; role:</span></span>
<span class="line" data-linenr="13"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">isSupervisor</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_SUPERVISOR</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="16"><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="17"></span>
<span class="line" data-linenr="18"><span style="color: #6B90C0; font-style: italic">// If we add a custom voter, we would be able to i.e. test if we are</span></span>
<span class="line" data-linenr="19"><span style="color: #6B90C0; font-style: italic">// able to view a user&#39;s profile:</span></span>
<span class="line" data-linenr="20"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">canViewProfile</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">    </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">VIEW</span><span style="color: #999999">&#39;</span><span style="color: #999999">],</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getUser</span><span style="color: #999999">()</span><span style="color: #BBBBBB"> </span><span style="color: #6B90C0; font-style: italic">// some context for the &quot;view&quot; action</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>
    
      <h2 id="relation-with-the-symfony-framework">
        
        
          <a href="#relation-with-the-symfony-framework" class="section-link"></a> Relation with the Symfony Framework
        
        
      </h2>

<p>Now, if we take a look at the configuration for the SecurityBundle, we’ll find
many relations with the architecture used above:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #C7C8D2">security</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Providers: UserProvider classes</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">providers</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">in_memory</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># indicating the InMemoryUserProvider</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">memory</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">~</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># The UserPasswordEncoders</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">encoders</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">Symfony\Component\Security\Core\User\UserInterface</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">plaintext</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Firewalls are listeners of the HTTP component that</span></span>
<span class="line" data-linenr="13"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># execute authentication based on paths</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">firewalls</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="15"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="16"></span>
<span class="line" data-linenr="17"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># Each firewall configures a list of authentication providers</span></span>
<span class="line" data-linenr="18"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># used for this AuthenticationProviderManager. I.e. all</span></span>
<span class="line" data-linenr="19"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># firewalls are one AuthenticationProviderManager (and thus,</span></span>
<span class="line" data-linenr="20"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># one security system).</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">main</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="22"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># AnonymousAuthenticationProvider</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">anonymous</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="24"></span>
<span class="line" data-linenr="25"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># Use UsernamePasswordToken and DaoAuthenticationProvider</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">http_basic</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">form_login</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="28"></span>
<span class="line" data-linenr="29"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Relate to AccessDecisionManager#isGranted() calls for</span></span>
<span class="line" data-linenr="30"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># specific paths</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">access_control</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">        </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">path</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">^/admin</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">roles</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">ROLE_ADMIN</span><span style="color: #BBBBBB"> </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">        </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">path</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">^/profile</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">roles</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">ROLE_USER</span><span style="color: #BBBBBB"> </span><span style="color: #999999">}</span></span></code></pre>
</div>
    
      <h2 id="take-homes">
        
        
          <a href="#take-homes" class="section-link"></a> Take Home’s
        
        
      </h2>

<p>I hope this posts has provided you some insights in how the Security component
works.</p>

<ul>
  <li>Security HTTP is only a small layer converting HTTP requests into input for
the Security system</li>
  <li>There are many similarities between the config in the Symfony framework and
the workings of the Security Core component</li>
  <li>A complete working implementation of the Security component can be achieved
in 20 lines of PHP</li>
</ul>

<p>In this posts, you might have also observed some weird things. I’ll go into
further detail on them in later posts.</p>

<ul>
  <li>There is no build-in authorization for API tokens</li>
  <li>The token representing user input is the same as the authenticated token</li>
  <li>Authorization by default is on the <em>identity</em> rather than the <em>action</em></li>
</ul>

        </div>
    </div>
</article>

    </div><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2023 Wouter de Jong</p>
</footer>
</body>

</html>
