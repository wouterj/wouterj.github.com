<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Symfony Security: Is Security about User management? ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css?v2">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96>
    <link rel="me" href="https://phpc.social/@wouterj"><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta property="og:title" content="Symfony Security: Is Security about User management?">
      <meta property="og:type" content="article">
      <meta property="og:description" content="Symfony 2 completely renewed Symfony. Symfony 3 gave us a completely refactored
and improved Form component. Symfony 4 gave us a renewed dependency injection
experience. Let’s fix Security in Symfony 5! To start with: The concept of
users in security.

">
      <meta property="article:published_time" content="2019-03-11T00:00:00+00:00">
      <meta property="og:url" content="https://wouterj.nl/2019/03/security-removing-user">
      <meta property="og:image" content="https://wouterj.nl/img/og/security-removing-user.png">
      <meta property="og:image:height" content="340">
      <meta property="og:image:width" content="680">

      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@wouterjnl">
      <meta name="twitter:creator" content="@wouterjnl">
      <meta name="twitter:title" content="Symfony Security: Is Security about User management?">
      <meta name="twitter:description" content="Symfony 2 completely renewed Symfony. Symfony 3 gave us a completely refactored
and improved Form component. Symfony 4 gave us a renewed dependency injection
experience. Let’s fix Security in Symfony 5! To start with: The concept of
users in security.

">
      <meta name="twitter:image" content="https://wouterj.nl/img/og/security-removing-user.png">
    <script src="https://cdn.counter.dev/script.js" data-id="07663ec4-bb0d-40fb-ad71-e7b091c17341" data-utcoffset="1"></script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav"></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="post__heading" itemprop="headline">Symfony Security: Is Security about User management?</h1>

    <div class="post__metadata">
        <time class="post__published-date" datetime="2019-03-11T00:00:00+00:00" itemprop="datePublished">
            MAR '19
        </time>
        
        <span class="post__category">
            
            
            <span class="post__category__icon">&#xf051;</span>
            
            experiment
        </span>
        
    </div>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>Symfony 2 completely renewed Symfony. Symfony 3 gave us a completely refactored
and improved Form component. Symfony 4 gave us a renewed dependency injection
experience. Let’s fix Security in Symfony 5! To start with: The concept of
users in security.</p></div><div class="post__entry">

<p>The Security guide has 36 official documentation articles. This means it’s
by far record holder. The Dependency Injection component is on place two with
just 26 articles. Also, a book about Security is in <a href="https://leanpub.com/bookstore/type/book/sort/lifetime_earnings?search=symfony">leanpub’s top selling
Symfony list</a> (congratz <a href="https://leanpub.com/u/jaytaph">Joshua</a>!). The Security component
needs fixing! <em>What can we do?</em></p>
      <h2 id="whats-the-problem">
        
        
          <a href="#whats-the-problem" class="section-link"></a> What’s the problem?
        
        
      </h2>

<p>Users are <em>your</em> domain logic. Yet, the component forces your user to implement
<code class="highlighter-shiki">UserInterface</code>. This requires you to define a <em>salt</em> (mostly empty),
<em>username</em> (probably <code class="highlighter-shiki">return $this-&gt;getEmail();</code>) and <em>password</em> (I hope you
aren’t using tokens in your API?).</p>

<aside class="side" data-type="Reference">
  <p>In the blogpost, Iltar van der Berg uses two objects: A domain <code class="highlighter-shiki">User</code> and
<code class="highlighter-shiki">SecurityUser</code>. The security user provider creates a <code class="highlighter-shiki">SecurityUser</code> based on
information from the domain <code class="highlighter-shiki">User</code>. This way, the domain <code class="highlighter-shiki">User</code> becomes
decoupled from the Security component.</p>
</aside>

<p>You can <a href="https://stovepipe.systems/post/decoupling-your-security-user">decouple the security user from your domain one</a>.
Yet, doing so means that you have to write a custom service to get the
domain user in your controller/services. All Security <code class="highlighter-shiki">getUser()</code> methods will
return the Security user and not the domain one. That means writing custom core
functionality to fix a problem in the component.</p>
    
      <h3 id="what-is-security-without-a-user">
        
        
          <a href="#what-is-security-without-a-user" class="section-link"></a> What is Security without a User?
        
        
      </h3>

<p>A lot actually. The core of the Security component needs no users. <em>Token</em>
objects (not related to API tokens) contain all necessary information about the
user. After authentication, the user object is saved in this token, together
with the credentials and the roles.</p>

<p><img src="/img/security1-current-uml.png" alt="User and Token UML diagram" /></p>

<aside class="side" data-type="Symfony internals">
  <p>The Security component consists of separate layers. The <em>Core
subcomponent</em> contains the generic Security objects and abstractions. The <em>Http
subcomponent</em> integrates this Core system with the HTTP world of requests,
sessions and login forms. Learn more about this in <a href="https://www.youtube.com/watch?v=xQyEXzug7P8">this great talk from Kris
Wallsmith</a>.</p>
</aside>

<p>At this point, you might wonder why there are two objects: Token and User.
They both contain the username, user roles and password… I agree, we can
remove one of the two concepts.</p>

<p>The user object also creates another problem: The user object is part of the
authenticated token. This means it’s serialized when the token is stored in the
session. This means your user object has to be serializable: It needs to remove
plain text passwords, resources and other stuff you don’t want to serialize.</p>
    
      <h2 id="is-there-a-way-to-fix-it">
        
        
          <a href="#is-there-a-way-to-fix-it" class="section-link"></a> Is there a way to fix it?
        
        
      </h2>

<p>Yes: remove users. Wait, whaat?! Security is all about getting a user, right?
Well, I don’t think so. Security is about securing your resources (pages,
files, etc.). That’s all security should provide as a base. To do this, a
unique identifier is needed to identify who is asking permission to access.
This means we get the user feature as a very nice bonus, but it isn’t the main
goal of Security.</p>

<p>With that in mind, I’ve described why users cause problems. I’ve also already
shown what other unique identifer Security has besides the User object: Tokens.
Actually, everything Security needs is already in these tokens, so no need for
user objects in the component!</p>

<p>However, being able to typehint for <code class="highlighter-shiki">UserInterface</code> in the controller is great.
Removing users from the component make this is impossible: The Security
component can no longer relate the token with a user object that you created.</p>

<p>To fix this, tokens can save a plain text identifier for the user. You can set
this to the id of your domain user. The component can provide some automatic
loaders of this Client entity based on the ID, like the current user
providers.</p>

<p><img src="/img/security1-proposed-uml.png" alt="Proposed UML diagram" /></p>
    
      <h2 id="how-does-this-impact-my-code">
        
        
          <a href="#how-does-this-impact-my-code" class="section-link"></a> How does this Impact my Code?
        
        
      </h2>

<p>As a base, this means your user object does no longer contain anything from the
Security component.</p>
    
      <h4 id="before">
        
        
          <a href="#before" class="section-link"></a> Before
        
        
      </h4>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UserInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ApiUser</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserInterface</span></span>
<span class="line" data-linenr="4"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">__construct</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">array</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">email</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">roles</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="13"></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getUsername</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="18"></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getPassword</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">none</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="23"></span>
<span class="line" data-linenr="24"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getSalt</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">null;</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="28"></span>
<span class="line" data-linenr="29"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getRoles</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="33"></span>
<span class="line" data-linenr="34"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="35"><span style="color: #999999">}</span></span></code></pre>
</div>
    
      <h4 id="after">
        
        
          <a href="#after" class="section-link"></a> After
        
        
      </h4>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">User</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">__construct</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">email</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">roles</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getEmail</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">email</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="16"></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getRoles</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">roles</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="21"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>When you want to use <code class="highlighter-shiki">getUser()</code> functions, you only have to implement a simple
interface:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #C7C8D2">IdentityInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">User</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">IdentityInterface</span></span>
<span class="line" data-linenr="4"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getIdentifier</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">id</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>As you can see, this all becomes way more flexible. Your user only needs to
have some unique identifier and all other information is in the tokens.</p>

<p>The benefit of this is that the Security component only needs to serialize the token
in the session. This means your user object or whatsoever doesn’t need to be
serializable, doesn’t need to erase credentials, cetera.</p>
    
      <h2 id="take-homes">
        
        
          <a href="#take-homes" class="section-link"></a> Take Home’s
        
        
      </h2>

<ul>
  <li>Security isn’t about the user</li>
  <li>Users are <em>your domain</em>, a framework should not interfere with that</li>
  <li>Identifiers link objects with the same meaning</li>
</ul>

<p>Of course, this post is just proposing ideas. I’m sure there will be
difficulties to integrate this into the Symfony code. But I believe it is
necessary to rethink what’s needed in the Symfony Security component.
Integrating the Security component should be easier. Reducing classes that need
to be modified to use Security helps with this.</p>

        </div>
    </div>
</article>

    </div><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2023 Wouter de Jong</p>
</footer>
</body>

</html>
