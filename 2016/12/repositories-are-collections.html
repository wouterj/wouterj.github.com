<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Repositories are just Collections ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css?v2">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96>
    <link rel="me" href="https://phpc.social/@wouterj"><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta property="og:title" content="Repositories are just Collections">
      <meta property="og:type" content="article">
      <meta property="og:description" content="Repositories are just collections of things. A post repository is a collection
of posts, a user repository a collection of users. They allow to abstract away
all the persistence details. Yet, many people think of Doctrine repositories as
purely related to Doctrine, leading to strange abstractions. Let’s create a
normal collection with Symfony and Doctrine today!

">
      <meta property="article:published_time" content="2016-12-15T00:00:00+00:00">
      <meta property="og:url" content="https://wouterj.nl/2016/12/repositories-are-collections">
      <meta property="og:image" content="https://wouterj.nl/img/og/repositories-are-collections.png">
      <meta property="og:image:height" content="340">
      <meta property="og:image:width" content="680">

      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@wouterjnl">
      <meta name="twitter:creator" content="@wouterjnl">
      <meta name="twitter:title" content="Repositories are just Collections">
      <meta name="twitter:description" content="Repositories are just collections of things. A post repository is a collection
of posts, a user repository a collection of users. They allow to abstract away
all the persistence details. Yet, many people think of Doctrine repositories as
purely related to Doctrine, leading to strange abstractions. Let’s create a
normal collection with Symfony and Doctrine today!

">
      <meta name="twitter:image" content="https://wouterj.nl/img/og/repositories-are-collections.png">
    <script src="https://cdn.counter.dev/script.js" data-id="07663ec4-bb0d-40fb-ad71-e7b091c17341" data-utcoffset="1"></script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav"></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="post__heading" itemprop="headline">Repositories are just Collections</h1>

    <div class="post__metadata">
        <time class="post__published-date" datetime="2016-12-15T00:00:00+00:00" itemprop="datePublished">
            DEC '16
        </time>
        
        <span class="post__category">
            
            
            <span class="post__category__icon">&#xf139;</span>
            
            article
        </span>
        
    </div>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>Repositories are just collections of things. A post repository is a collection
of posts, a user repository a collection of users. They allow to abstract away
all the persistence details. Yet, many people think of Doctrine repositories as
purely related to Doctrine, leading to strange abstractions. Let’s create a
normal collection with Symfony and Doctrine today!</p></div><div class="post__entry">
      <h2 id="it-all-starts-with-the-interface">
        
        
          <a href="#it-all-starts-with-the-interface" class="section-link"></a> It all starts with the Interface
        
        
      </h2>

<p>When designing your application, start with designing your interfaces. If you
like your interfaces, the implementation will probably be nice as well. In this
post, we’re going to design a collection of products. The interface first
contains some basic collection methods:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// src/AppBundle/Product/ProductRepository.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">namespace</span><span style="color: #BBBBBB"> AppBundle</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Product</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">interface</span><span style="color: #BBBBBB"> ProductRepository </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #999999">\</span><span style="color: #C7C8D2">Countable</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #6B90C0; font-style: italic">/** @return </span><span style="color: #C7C8D2; font-style: italic">Product</span><span style="color: #E5673D; font-style: italic">[]</span><span style="color: #6B90C0; font-style: italic"> */</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">all</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="8"></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #6B90C0; font-style: italic">/** @return </span><span style="color: #E5673D; font-style: italic">bool</span><span style="color: #6B90C0; font-style: italic"> */</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">includes</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    </span><span style="color: #6B90C0; font-style: italic">/** @return </span><span style="color: #E5673D; font-style: italic">int</span><span style="color: #6B90C0; font-style: italic"> */</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">count</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="14"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>We can now count the number of products in the collection, get all products in
the collection and check if a product is included in the collection. Now, let’s
add two simple methods for more specific operations on this collection:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// src/AppBundle/Product/ProductRepository.php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">interface</span><span style="color: #BBBBBB"> ProductRepository </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #999999">\</span><span style="color: #C7C8D2">Countable</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">add</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="8"></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #6B90C0; font-style: italic">/** @return </span><span style="color: #E5673D; font-style: italic">null</span><span style="color: #999999; font-style: italic">|</span><span style="color: #C7C8D2; font-style: italic">Product</span><span style="color: #6B90C0; font-style: italic"> */</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">byId</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">}</span></span></code></pre>
</div>
    
      <h2 id="a-basic-implementation">
        
        
          <a href="#a-basic-implementation" class="section-link"></a> A Basic Implementation
        
        
      </h2>

<p>The most straight-forward way to implement collections in PHP is by using
arrays. Let’s create an array based product collection:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// src/AppBundle/Product/ArrayBasedProductRepository.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">namespace</span><span style="color: #BBBBBB"> AppBundle</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Product</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ArrayBasedProductRepository</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ProductRepository</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">products</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[]</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">all</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="12"></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">includes</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">in_array</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="17"></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">count</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">count</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="22"></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">add</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="24"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #999999">[</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getId</span><span style="color: #999999">()]</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="27"></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">byId</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="29"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">!isset</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #999999">[</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">]))</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">null;</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="33"></span>
<span class="line" data-linenr="34"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">products</span><span style="color: #999999">[</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">]</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="36"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>Most of the methods in the interface can be mapped to simple PHP array
methods. This repository can be defined as a service:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># app/config/services.yml</span></span>
<span class="line" data-linenr="2"><span style="color: #C7C8D2">services</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">app.product_repository</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">class</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">AppBundle\Product\ArrayBasedProductRepository</span></span></code></pre>
</div>

<p>Then you can probably imagine how we would use this product collection in a
controller:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// src/AppBundle/Controller/ShopController.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">namespace</span><span style="color: #BBBBBB"> AppBundle</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Controller</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ShopController</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Controller</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">listAction</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">products</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">app.product_repository</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">all</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">render</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">shop/products.twig</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">            </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">products</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">products</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">        </span><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="15"></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">productInfoAction</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">productId</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">app.product_repository</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">byId</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">productId</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="19"></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">render</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">shop/product_info.twig</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">            </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">product</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">        </span><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">}</span></span></code></pre>
</div>
    
      <h2 id="using-doctrine">
        
        
          <a href="#using-doctrine" class="section-link"></a> Using Doctrine
        
        
      </h2>

<p>So far, we’ve only looked at normal repositories. I hope this brought the point
across that repositories are just collections. The nice thing about
repositories is that we can implement all sort of different backends for our
collections. As this post is also about Doctrine, let’s create a product
collection based on Doctrine.</p>

<p>The <code class="highlighter-shiki">EntityRepository</code> shipped with the Doctrine ORM is a simple wrapper class
around the entity manager and the unit of work. The class isn’t used in
Doctrine itself, it’s purely an easy starting point for the users. This means
we can completely drop it and base our doctrine collection on top of the entity
manager:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// src/AppBundle/Product/DoctrineBasedProductRepository.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">namespace</span><span style="color: #BBBBBB"> AppBundle</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Product</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Doctrine</span><span style="color: #999999">\</span><span style="color: #BBBBBB">ORM</span><span style="color: #999999">\</span><span style="color: #C7C8D2">EntityManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">DoctrineBasedProductRepository</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ProductRepository</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="9"></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">__construct</span><span style="color: #999999">(</span><span style="color: #C7C8D2">EntityManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">entityManager</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="14"></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">all</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="17"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Create a basic DQL query to fetch all entities</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">createQuery</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">SELECT</span><span style="color: #7CC64A"> p </span><span style="color: #E5673D">FROM</span><span style="color: #7CC64A"> </span><span style="color: #999999">&#39;</span><span style="color: #E5673D">.</span><span style="color: #C7C8D2">Product</span><span style="color: #E5673D">::class</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A"> p</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getResult</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="21"></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">includes</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Check if the entity is managed by the entity manager</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">contains</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="27"></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">count</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="29"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="30"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Create a basic count DQL query</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">createQuery</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">SELECT</span><span style="color: #7CC64A"> </span><span style="color: #C7C8D2">count</span><span style="color: #7CC64A">(p) </span><span style="color: #E5673D">FROM</span><span style="color: #7CC64A"> </span><span style="color: #999999">&#39;</span><span style="color: #E5673D">.</span><span style="color: #C7C8D2">Product</span><span style="color: #E5673D">::class</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A"> p</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getSingleScalarResult</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="34"></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">add</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="36"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">persist</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">product</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="38"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="39"></span>
<span class="line" data-linenr="40"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">byId</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="41"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="42"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Fetch a product by id (note: No need to use DQL or the EntityRepository here either!)</span></span>
<span class="line" data-linenr="43"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">entityManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">find</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Product</span><span style="color: #E5673D">::class</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">id</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="44"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="45"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>As you can see, the code in here is just a bit more complex than using the
array repository. Even better, the usage of this repository has not changed a
single bit when comparing it with the <code class="highlighter-shiki">ArrayBasedProductRepository</code>. So we only
have to update the service definitions to use doctrine:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># app/config/services.yml</span></span>
<span class="line" data-linenr="2"><span style="color: #C7C8D2">services</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">app.product_repository</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">class</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">AppBundle\Product\DoctrineBasedProductRepository</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">arguments</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">@doctrine.orm.entity_manager</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span></span></code></pre>
</div>
    
      <h2 id="treat-repositories-as-collections">
        
        
          <a href="#treat-repositories-as-collections" class="section-link"></a> Treat Repositories as Collections
        
        
      </h2>

<p>As I tried to show in this post, treating repositories as collections has some
significant advantages:</p>

<ul>
  <li>The collection implementation is abstracted away, not much hassle with
Doctrine anymore</li>
  <li>All collection methods are located in one class/service. This means you
never has to rely on both the entity repository and manager (in order to
fetch and persist) anymore</li>
  <li>Working with Doctrine as if it’s a collection makes programming easier to
follow</li>
</ul>

<p>My last warning of this post is to not add non-collection related methods in
the repository. I sometimes see people adding <code class="highlighter-shiki">getXxxQuery()</code> methods in the
repository, as e.g. the form type requires you to set a query. These methods
tell something about the implementation. They are no longer related to
collections (try to think what this method should return in the
<code class="highlighter-shiki">ArrayBasedProductRepository</code>).</p>
    
      <h2 id="take-homes">
        
        
          <a href="#take-homes" class="section-link"></a> Take Home’s
        
        
      </h2>

<ul>
  <li>The <code class="highlighter-shiki">EntityRepository</code> class shipped by Doctrine is purely to ease usage,
it’s not mandatory at all</li>
  <li>Writing your own repositories allow you to abstract away Doctrine almost
completely from your services and controllers</li>
  <li>Repositories are just collections, please treat them as such</li>
</ul>

        </div>
    </div>
</article>

    </div><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2023 Wouter de Jong</p>
</footer>
</body>

</html>
