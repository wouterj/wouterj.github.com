<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Random in PHP ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta content="Random in PHP" property="og:title">
      <meta content="article" property="og:type">
      <meta content="Een computer is logisch, hoe kan zo’n logisch apparaat nou random getallen
maken? Vandaag nemen we een kijk in de PHP source om te kijken hoe het in PHP
gedaan wordt.

" property="og:description">
      <meta content="2013-09-24T00:00:00+00:00" property="article:published_time">
      <meta content="https://wouterj.nl/2013/09/random-in-php" property="og:url">
      <meta content="https://wouterj.nl/img/og/random-in-php.png?1" property="og:image">
    <script>if(!sessionStorage.getItem("_swa")){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer.indexOf(location.protocol+"//"+location.host)!==0?document.referrer:'',screen:screen.width+"x"+screen.height,user:"wouterj",utcoffset:"2"}),{headers:{"X-Referer":"https://wouterj.nl/2013/09/random-in-php","Content-Type":"text/plain"}})};sessionStorage.setItem("_swa","1");</script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><!--<nav class=page__nav>
        <ul class="nav  nav--block"><li class="nav__item  "><a href="/categories/article/index.html"><i class=icon>&#xF139;</i> <span class="button__text">Articles</span></a></li><li class="nav__item  "><a href="/categories/experiment/index.html"><i class=icon>&#xF051;</i> <span class="button__text">Experiments</span></a></li><li class="nav__item  "><a href="/categories/links/index.html"><i class=icon>&#xF10E;</i> <span class="button__text">Links</span></a></li></ul>
    </nav>-->
  </div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    
        <span class="post__category">
        <time class="dt-published" datetime="2013-09-24T00:00:00+00:00" itemprop="datePublished">
            SEP '13
        </time>
        
        
        &#xf139;
        
        </span>
    

    <h1 class="post__heading" itemprop="headline">Random in PHP</h1>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>Een computer is logisch, hoe kan zo’n logisch apparaat nou random getallen
maken? Vandaag nemen we een kijk in de PHP source om te kijken hoe het in PHP
gedaan wordt.</p></div><div class="post__entry">
      <h2 id="de-php-source">
        
        
          <a href="#de-php-source" class="section-link"></a> De PHP source
        
        
      </h2>

<p>De PHP source is geschreven in C en je kunt een hele makkelijk navigeerbare
weergave van de source op <a href="http://lxr.php.net/">http://lxr.php.net/</a> vinden. Hier kun je zoeken naar
functies en makkelijk naar de source van functies navigeren.</p>

<p>Er is 1 basis conceptje die ik moet vertellen, de rest zal je gaanderweg wel
gaan begrijpen. Dit concept is defines in C. De C taal wordt eerst gecompiled
en vervolgens wordt die compiled code omgezet in uitvoerbare code. Tijdens het
compilen kun je wat dingen doe die PHP niet kan. Bijv. het gebruik van
defines. Defines zijn woorden die worden omgezet in de waarde die je er aan
meegeeft. Laten we beginnen met een simpele constante:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">#define M_PI 3.14159265358979323846
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Wanneer we nu in onze code <code class="highlighter-rouge">M_PI</code> gebruiken wordt dit vervangen door dit
getal:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">omtrek</span> <span class="o">=</span> <span class="n">M_PI</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Hier staat na het compilen eigenlijk:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">omtrek</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159265358979323846</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Naast het invullen van getallen of strings kun je ook macro’s definiëren.
Bijvoorbeeld deze macro:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">#define INCREMENT(x) x++
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Nu zal <code class="highlighter-rouge">INCREMENT(5)</code> worden omgezet in <code class="highlighter-rouge">6</code>.</p>
    
      <h2 id="random-getallen">
        
        
          <a href="#random-getallen" class="section-link"></a> Random getallen
        
        
      </h2>

<p>De andere basis kennis is het doorhebben hoe je random getallen maakt. Random
getallen zijn eigenlijk een sequence, je begint met een getal en stopt die in
een formule. Uit deze formule komt een getal, dit getal is het random getal en
die wordt opgeslagen in een variabele (dezelfde variabele als het begin
getal). Dit getal wordt dan weer gebruikt om met dezelfde functie weer een
getal te genereren, die ook weer wordt opgeslagen en als je de functie nog een
keer aanroept komt er weer een ander getal uit.</p>

<p>Je zal wel begrijpen dat je dan een hele rij van allemaal nieuwe random
getallen krijgt. Wanneer je met hetzelfde getal begint zal er altijd dezelfde
rij uitkomen. Dit eerste getal noemen we een <em>seed</em>. De seed wordt random
gecreeërd, bijvoorbeeld door de tijd en datum te gebruiken. Op deze manier heb
je dus nooit dezelfde random reeks getallen.</p>
    
      <h2 id="de-rand-functie">
        
        
          <a href="#de-rand-functie" class="section-link"></a> De <code class="highlighter-rouge">rand</code> functie
        
        
      </h2>

<p>Nu je de basiskennis hebt gaan we kijken in de PHP source code. De meeste
functies worden aangemaakt door <code class="highlighter-rouge">PHP_FUNCTION(rand)</code>. Als we opzoek willen
naar de <code class="highlighter-rouge">rand</code> functie zoeken we op <code class="highlighter-rouge">"PHP_FUNCTION rand"</code> (vergeet de quotes
niet). In de <a href="http://lxr.php.net/search?q=%22PHP_FUNCTION+rand%22&amp;defs=&amp;refs=&amp;path=&amp;hist=&amp;project=PHP_5_4">resultaten</a> krijgen we dan 2 bestanden: <code class="highlighter-rouge">php_math.h</code> en
<code class="highlighter-rouge">rand.c</code>. De <code class="highlighter-rouge">*.h</code> bestanden zijn header bestanden, die vertellen wat er
allemaal in de <code class="highlighter-rouge">*.c</code> bestanden staat. De <code class="highlighter-rouge">*.c</code> bestanden bevatten de echte
code. We klikken dus op die link en navigeren naar <a href="http://lxr.php.net/xref/PHP_5_4/ext/standard/rand.c#290">regel 290</a>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">min</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">max</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">number</span><span class="p">;</span>
    <span class="kt">int</span>  <span class="n">argc</span> <span class="o">=</span> <span class="n">ZEND_NUM_ARGS</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">argc</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="s">"ll"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">number</span> <span class="o">=</span> <span class="n">php_rand</span><span class="p">(</span><span class="n">TSRMLS_C</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RAND_RANGE</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">PHP_RAND_MAX</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">RETURN_LONG</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>En dat is de functie!</p>
    
      <h3 id="parsen-van-argumenten">
        
        
          <a href="#parsen-van-argumenten" class="section-link"></a> Parsen van argumenten
        
        
      </h3>

<p>Als eerst zien we dat er 4 variabelen gedeclareerd worden:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">min</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">max</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">number</span><span class="p">;</span>
<span class="kt">int</span>  <span class="n">argc</span> <span class="o">=</span> <span class="n">ZEND_NUM_ARGS</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>De eerste 3 variabelen zijn of argumenten of variabele die we verder in de
functie gaan gebruiken. De 4e variabele, <code class="highlighter-rouge">argc</code>, is het aantal argumenten.
Zend is de engine achter PHP en we kunnen wel raden wat <code class="highlighter-rouge">ZEND_NUM_ARGS()</code>
doet, we gaan dus niet naar die source code kijken.</p>

<p>Dan krijgen we een check voor de argumenten:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">argc</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="s">"ll"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>De check <code class="highlighter-rouge">argc != 0</code> betekend dat we pas argumenten gaan checken als er
argumenten zijn, dit komt omdat de <code class="highlighter-rouge">rand</code> functie ook zonder argumenten
aangeroepen kan worden. Zodra er wel argumenten zijn moeten er meteen 2 zijn.
Met <code class="highlighter-rouge">zend_parse_parameters</code> parsen we de argumenten. We zien <code class="highlighter-rouge">"ll"</code>, dit
betekend dat beide argumenten <code class="highlighter-rouge">long</code> (een soort float) zijn. Daarachter zien
we <code class="highlighter-rouge">&amp;min</code> en <code class="highlighter-rouge">&amp;max</code>, dit betekend dat de waarde van de argumenten worden mee
gegeven aan de variabelen <code class="highlighter-rouge">min</code> en <code class="highlighter-rouge">max</code> (die we hiervoor al gedeclareerd
hadden).</p>
    
      <h3 id="het-maken-van-de-seed">
        
        
          <a href="#het-maken-van-de-seed" class="section-link"></a> Het maken van de seed
        
        
      </h3>

<p>Dan gaan we de seed maken:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">number</span> <span class="o">=</span> <span class="n">php_rand</span><span class="p">(</span><span class="n">TSRMLS_C</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In deze regel roepen we de functie <code class="highlighter-rouge">php_rand</code> (een interne functie die niet in
PHP bestaat) aan. Die geven we ook weer een waarde mee, die is voor nu even
niet interessant.</p>

<p>Wat wel interessant is hoe PHP die random seed maakt. Dus klikken we op de
functie <code class="highlighter-rouge">php_rand</code> om die source te bekijken:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="n">PHPAPI</span> <span class="kt">long</span> <span class="nf">php_rand</span><span class="p">(</span><span class="n">TSRMLS_D</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BG</span><span class="p">(</span><span class="n">rand_is_seeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">php_srand</span><span class="p">(</span><span class="n">GENERATE_SEED</span><span class="p">()</span> <span class="n">TSRMLS_CC</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#ifdef ZTS
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">php_rand_r</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BG</span><span class="p">(</span><span class="n">rand_seed</span><span class="p">));</span>
<span class="cp">#else
# if defined(HAVE_RANDOM)
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">random</span><span class="p">();</span>
<span class="cp"># elif defined(HAVE_LRAND48)
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">lrand48</span><span class="p">();</span>
<span class="cp"># else
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
<span class="cp"># endif
#endif
</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Wat we hier heel in het kort zien is dat de functie, afhankelijk van bepaalde
instellingen, de C functies <code class="highlighter-rouge">rand</code>, <code class="highlighter-rouge">lrand48</code> of <code class="highlighter-rouge">random</code> gebruikt.</p>
    
      <h3 id="het-maken-van-het-random-getal">
        
        
          <a href="#het-maken-van-het-random-getal" class="section-link"></a> Het maken van het random getal
        
        
      </h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RAND_RANGE</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">PHP_RAND_MAX</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Zodra er 2 argumenten zijn gegeven wordt de <code class="highlighter-rouge">RAND_RANGE</code> define functie
gebruikt om het random nummer tussen 2 waardes te maken. Zodra je dus geen
argumenten geeft, krijg je gewoon de seed terug.</p>

<p>Nu zijn we natuurlijk benieuwd wat voor algoritme PHP gebruikt voor het maken
van het random getal, dus klikken we erop en gaan we naar een
<a href="http://lxr.php.net/xref/PHP_5_4/ext/standard/php_rand.h#43"><code class="highlighter-rouge">php_rand.h</code></a> bestand:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cp">#define RAND_RANGE(__n, __min, __max, __tmax) \
    (__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>En dat is de magische formule achter PHP’s <code class="highlighter-rouge">rand</code> functie! Er wordt mooi
gespeelt met wat afronden (de <code class="highlighter-rouge">(long)</code>’s en <code class="highlighter-rouge">(double)</code>’s in de code), de min
en max (<code class="highlighter-rouge">__min</code> en <code class="highlighter-rouge">__max</code>) worden een paar keer gebruikt en ook onze seed
(<code class="highlighter-rouge">__n</code>) wordt gebruikt. Vervolgens zien we ook <code class="highlighter-rouge">(__n) = ...</code>, waardoor onze
seed dus weer vernieuwd wordt door het gegenereerde random getal.</p>
    
      <h3 id="het-returnen-van-het-getal">
        
        
          <a href="#het-returnen-van-het-getal" class="section-link"></a> Het returnen van het getal
        
        
      </h3>

<p>Het enige dat ons nog rest is het returnen van de gemaakt <code class="highlighter-rouge">long</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">RETURN_LONG</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Achter deze simpele regel zit weer heel wat zend gedoe, maar daar bemoeien we
ons vandaag niet mee.</p>
    
      <h2 id="dus">
        
        
          <a href="#dus" class="section-link"></a> Dus…
        
        
      </h2>

<p>Je hoofd duizeld nu van de C code, maar je hebt wel begrepen hoe je kan kijken
hoe PHP functies werken. Ook heb je geleerd dat een goede random functie 4
factoren heeft: Niet voorspelbaar; geen herhalend patroon; alle getallen
moeten ongeveer gelijk voorkomen; dezelfde seed zorgt voor dezelfde rij random
getallen.</p>

        </div>
    </div>
</article>

    </main><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2022 Wouter de Jong</p>
</footer>
</body>

</html>
