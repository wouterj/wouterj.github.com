<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Using Travis to build your Sculpin blog ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css?v2">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96>
    <link rel="me" href="https://phpc.social/@wouterj"><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta content="Using Travis to build your Sculpin blog" property="og:title">
      <meta content="article" property="og:type">
      <meta content="This static blog site is generated by Sculpin and hosted on
GitHub Pages. In this article, I’ll tell you how you can setup automatic
generation using Travis.

" property="og:description">
      <meta content="2015-02-17T00:00:00+00:00" property="article:published_time">
      <meta content="https://wouterj.nl/2015/02/using-travis-to-build-your-sculpin-blog" property="og:url">
      <meta content="https://wouterj.nl/img/og/using-travis-to-build-your-sculpin-blog.png?1" property="og:image">
    <script src="https://cdn.counter.dev/script.js" data-id="07663ec4-bb0d-40fb-ad71-e7b091c17341" data-utcoffset="1"></script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav"></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="post__heading" itemprop="headline">Using Travis to build your Sculpin blog</h1>

    <div class="post__metadata">
        <time class="post__published-date" datetime="2015-02-17T00:00:00+00:00" itemprop="datePublished">
            FEB '15
        </time>
        
        <span class="post__category">
            
            
            <span class="post__category__icon">&#xf139;</span>
            
            article
        </span>
        
    </div>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>This static blog site is generated by <a href="http://sculpin.io/">Sculpin</a> and hosted on
<a href="https://pages.github.com/">GitHub Pages</a>. In this article, I’ll tell you how you can setup automatic
generation using <a href="https://travis-ci.org/">Travis</a>.</p></div><div class="post__entry">
      <h2 id="the-publish-script">
        
        
          <a href="#the-publish-script" class="section-link"></a> The Publish Script
        
        
      </h2>

<p>Generating a Sculpin site is basically executing some commands. Let’s create a
<code class="highlighter-shiki">publish.sh</code> file which will execute all commands required to generate the
site:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># build site</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">$ sass source/css/wouterj.scss:source/css/wouterj.css --style compressed --no-cache</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">$ ./vendor/bin/sculpin generate --env prod</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">$ touch output_prod/.nojekyll</span></span></code></pre>
</div>

<p>As this site uses Sass, it first needs to compile the sass code into a css
file. Then, Sculpin is used to generate the site for production. At last, a
<code class="highlighter-shiki">.nojekyll</code> file is created, to make sure GitHub Pages is not going to try to
render the site as a Jekyll blog.</p>

<p>To make Travis execute this file, you need some Travis configuration:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"><span style="color: #C7C8D2">language</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">php</span></span>
<span class="line" data-linenr="3"><span style="color: #C7C8D2">php</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">  </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">hhvm</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #C7C8D2">sudo</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">false</span></span>
<span class="line" data-linenr="7"><span style="color: #C7C8D2">cache</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">  </span><span style="color: #C7C8D2">directories</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">$HOME/.composer/cache</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #C7C8D2">before_script</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">  </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">gem install sass</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">  </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">composer install --prefer-dist</span></span>
<span class="line" data-linenr="14"></span>
<span class="line" data-linenr="15"><span style="color: #C7C8D2">script</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">  </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">sh publish.sh</span></span></code></pre>
</div>

<p>The first 9 lines are setting up the quickest Travis PHP build: HHVM, caching,
Docker environment, etc. The lines after this install Sass and the dependencies
(yes, I commit <code class="highlighter-shiki">composer.lock</code>). The real Travis script executes the <code class="highlighter-shiki">publish.sh</code>
file.</p>

<div class="highlighter-shiki"><pre class="shiki language-none"><code>[note]
Sculpin is added as a dependency in `composer.json` as shown under &quot;Download
via Composer&quot; on the [download page][6].
</code></pre>
</div>
    
      <h2 id="the-branching-strategy">
        
        
          <a href="#the-branching-strategy" class="section-link"></a> The Branching Strategy
        
        
      </h2>

<p>The <code class="highlighter-shiki">master</code> branch is always used by GitHub Pages, so the source code is
pushed to a <code class="highlighter-shiki">source</code> branch. This branch is also set up as the default branch
on GitHub, as this is the only branch you should care about.</p>

<p>To make sure that Travis only runs builds on the <code class="highlighter-shiki">source</code> branch, use the
<code class="highlighter-shiki">branches.only</code> setting:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="4"><span style="color: #C7C8D2">branches</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">  </span><span style="color: #C7C8D2">only</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">source</span></span></code></pre>
</div>
    
      <h2 id="commiting-the-build">
        
        
          <a href="#commiting-the-build" class="section-link"></a> Commiting the Build
        
        
      </h2>

<p>The idea now is to make Travis change the root of the repository to the
<code class="highlighter-shiki">output_prod</code> directory, commit and push it as the <code class="highlighter-shiki">master</code> branch. First, some
Git config is required:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># publish.sh</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># configure env</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">git config --global user.email </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">your_email@example.com</span><span style="color: #999999">&#39;</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">git config --global user.name </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">WouterJ.nl bot</span><span style="color: #999999">&#39;</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #6B90C0; font-style: italic"># ... build site section</span></span></code></pre>
</div>

<p>Since the build is executed on the <code class="highlighter-shiki">source</code> branch, Travis need to checkout the
<code class="highlighter-shiki">master</code> branch. However, as <code class="highlighter-shiki">master</code> is going to be replaced each time, it should
just delete current <code class="highlighter-shiki">master</code> and create a new one based on the <code class="highlighter-shiki">source</code> branch:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># ... configure env section</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># checkout publish branch</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">git branch -D master</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">git checkout -b master</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #6B90C0; font-style: italic"># ... build site section</span></span></code></pre>
</div>

<p>Travis is in the <code class="highlighter-shiki">master</code> branch and has build the site in <code class="highlighter-shiki">output_prod</code> now.
Git can make this output directory the new root of the branch using the <code class="highlighter-shiki">git
filter-branch</code> command. Before executing this, Travis has to commit the
currently added files (the <code class="highlighter-shiki">output_prod</code> directory):</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># ... configure env, checkout publish branch and build site sections</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic"># commit build</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">git add -f output_prod</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">git commit -m </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">Build website</span><span style="color: #999999">&quot;</span></span></code></pre>
</div>

<p>The <code class="highlighter-shiki">-f</code> is required, as output directories are in the <code class="highlighter-shiki">.gitignore</code> file of
a common Sculpin blog. Now, execute the <code class="highlighter-shiki">git filter-branch</code> command:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic"># only commit output dir</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">git filter-branch --subdirectory-filter output_prod/ -f</span></span></code></pre>
</div>
    
      <h2 id="pushing-the-result">
        
        
          <a href="#pushing-the-result" class="section-link"></a> Pushing the Result
        
        
      </h2>

<p>The branch is ready to be pushed back to GitHub, so let’s do that!</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic"># push to GitHub Pages</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">git push </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">https://github.com/WouterJ/wouterj.github.com</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> -f master</span></span></code></pre>
</div>

<p>Wait a moment… It needs either a username and password or a GitHub token in
order to push. This means that everyone can see my GitHub token. That’s a huge
security leak!</p>

<p>Fortunately, Travis allows you to encrypt the token in a special way that only
works for your repository. This way, you’re the only person who can use this
token. Download the <a href="https://github.com/travis-ci/travis.rb">Travis command line app</a> and use the <code class="highlighter-shiki">travis encrypt</code>
command to encrypt your public token to an environment variable:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ travis encrypt --add GH_TOKEN=XXX</span></span></code></pre>
</div>

<p>(<code class="highlighter-shiki">XXX</code> is your github token here).</p>

<div class="highlighter-shiki"><pre class="shiki language-none"><code>[caution]
Be sure to execute this when your in the directory of your blog repository.
</code></pre>
</div>

<p>As the <code class="highlighter-shiki">--add</code> option was added, the encrypted string is added to your
<code class="highlighter-shiki">.travis.yml</code> configuration. Using this directly like
<code class="highlighter-shiki">git push http://$GH_TOKEN@github.com/...</code> will still show your github token in
the output of the command. You have to put it in the <code class="highlighter-shiki">~/.netrc</code> of the Linux
environment before executing this command. This file is used by Linux to
authenticate with ssh servers.</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># .travis.yml</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="4"><span style="color: #C7C8D2">before_install</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">  </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">echo -e &quot;machine github.com\n  login $GH_TOKEN&quot; &gt;&gt; ~/.netrc</span></span></code></pre>
</div>
    
      <h2 id="round-up">
        
        
          <a href="#round-up" class="section-link"></a> Round Up
        
        
      </h2>

<p>Congrats, you have a running Sculpin blog on GitHub Pages using automatic
buildings with Travis! Everytime you push to your blog’s <code class="highlighter-shiki">source</code> branch, the
site will be regenerated. There are even more nice features:</p>

<ul>
  <li>You get a notification when the build failed</li>
  <li>The output is never pushed when the build failed, meaning you always have a
working site</li>
</ul>

<p>You can see the complete files in <a href="https://github.com/WouterJ/wouterj.github.com">the repository of this site</a>.</p>

        </div>
    </div>
</article>

    </div><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2023 Wouter de Jong</p>
</footer>
</body>

</html>
