<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Using Travis to build your Sculpin blog ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><meta content="Wouter J" property="og:site_name">
    
      <meta content="Using Travis to build your Sculpin blog" property="og:title">
      <meta content="article" property="og:type">
      <meta content="This static blog site is generated by Sculpin and hosted on
GitHub Pages. In this article, I’ll tell you how you can setup automatic
generation using Travis.

" property="og:description">
      <meta content="2015-02-17T00:00:00+00:00" property="article:published_time">
      <meta content="https://wouterj.nl/2015/02/using-travis-to-build-your-sculpin-blog" property="og:url">
      <meta content="https://wouterj.nl/img/og/using-travis-to-build-your-sculpin-blog.png?1" property="og:image">
    <script>if(!sessionStorage.getItem("_swa")){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer.indexOf(location.protocol+"//"+location.host)!==0?document.referrer:'',screen:screen.width+"x"+screen.height,user:"wouterj",utcoffset:"2"}),{headers:{"X-Referer":"https://wouterj.nl/2015/02/using-travis-to-build-your-sculpin-blog","Content-Type":"text/plain"}})};sessionStorage.setItem("_swa","1");</script></head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><!--<nav class=page__nav>
        <ul class="nav  nav--block"><li class="nav__item  "><a href="/categories/article/index.html"><i class=icon>&#xF139;</i> <span class="button__text">Articles</span></a></li><li class="nav__item  "><a href="/categories/experiment/index.html"><i class=icon>&#xF051;</i> <span class="button__text">Experiments</span></a></li><li class="nav__item  "><a href="/categories/links/index.html"><i class=icon>&#xF10E;</i> <span class="button__text">Links</span></a></li></ul>
    </nav>-->
  </div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    
        <span class="post__category">
        <time class="dt-published" datetime="2015-02-17T00:00:00+00:00" itemprop="datePublished">
            FEB '15
        </time>
        
        
        &#xf139;
        
        </span>
    

    <h1 class="post__heading" itemprop="headline">Using Travis to build your Sculpin blog</h1>

    

    <div itemprop="articleBody">
        <div class="post__entry--excerpt">
            
            <p>This static blog site is generated by <a href="http://sculpin.io/">Sculpin</a> and hosted on
<a href="https://pages.github.com/">GitHub Pages</a>. In this article, I’ll tell you how you can setup automatic
generation using <a href="https://travis-ci.org/">Travis</a>.</p></div><div class="post__entry">
      <h2 id="the-publish-script">
        
        
          <a href="#the-publish-script" class="section-link"></a> The Publish Script
        
        
      </h2>

<p>Generating a Sculpin site is basically executing some commands. Let’s create a
<code class="highlighter-rouge">publish.sh</code> file which will execute all commands required to generate the
site:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c"># build site</span>
<span class="nv">$ </span>sass <span class="nb">source</span>/css/wouterj.scss:source/css/wouterj.css <span class="nt">--style</span> compressed <span class="nt">--no-cache</span>
<span class="nv">$ </span>./vendor/bin/sculpin generate <span class="nt">--env</span> prod
<span class="nv">$ </span><span class="nb">touch </span>output_prod/.nojekyll
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As this site uses Sass, it first needs to compile the sass code into a css
file. Then, Sculpin is used to generate the site for production. At last, a
<code class="highlighter-rouge">.nojekyll</code> file is created, to make sure GitHub Pages is not going to try to
render the site as a Jekyll blog.</p>

<p>To make Travis execute this file, you need some Travis configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># .travis.yml</span>
<span class="na">language</span><span class="pi">:</span> <span class="s">php</span>
<span class="na">php</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">hhvm</span>

<span class="na">sudo</span><span class="pi">:</span> <span class="no">false</span>
<span class="na">cache</span><span class="pi">:</span>
  <span class="na">directories</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">$HOME/.composer/cache</span>

<span class="na">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">gem install sass</span>
  <span class="pi">-</span> <span class="s">composer install --prefer-dist</span>

<span class="na">script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">sh publish.sh</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The first 9 lines are setting up the quickest Travis PHP build: HHVM, caching,
Docker environment, etc. The lines after this install Sass and the dependencies
(yes, I commit <code class="highlighter-rouge">composer.lock</code>). The real Travis script executes the <code class="highlighter-rouge">publish.sh</code>
file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[note]
Sculpin is added as a dependency in `composer.json` as shown under "Download
via Composer" on the [download page][6].
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="the-branching-strategy">
        
        
          <a href="#the-branching-strategy" class="section-link"></a> The Branching Strategy
        
        
      </h2>

<p>The <code class="highlighter-rouge">master</code> branch is always used by GitHub Pages, so the source code is
pushed to a <code class="highlighter-rouge">source</code> branch. This branch is also set up as the default branch
on GitHub, as this is the only branch you should care about.</p>

<p>To make sure that Travis only runs builds on the <code class="highlighter-rouge">source</code> branch, use the
<code class="highlighter-rouge">branches.only</code> setting:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1"># .travis.yml</span>

<span class="c1"># ...</span>
<span class="na">branches</span><span class="pi">:</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">source</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="commiting-the-build">
        
        
          <a href="#commiting-the-build" class="section-link"></a> Commiting the Build
        
        
      </h2>

<p>The idea now is to make Travis change the root of the repository to the
<code class="highlighter-rouge">output_prod</code> directory, commit and push it as the <code class="highlighter-rouge">master</code> branch. First, some
Git config is required:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c"># publish.sh</span>

<span class="c"># configure env</span>
git config <span class="nt">--global</span> user.email <span class="s1">'your_email@example.com'</span>
git config <span class="nt">--global</span> user.name <span class="s1">'WouterJ.nl bot'</span>

<span class="c"># ... build site section</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since the build is executed on the <code class="highlighter-rouge">source</code> branch, Travis need to checkout the
<code class="highlighter-rouge">master</code> branch. However, as <code class="highlighter-rouge">master</code> is going to be replaced each time, it should
just delete current <code class="highlighter-rouge">master</code> and create a new one based on the <code class="highlighter-rouge">source</code> branch:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c"># ... configure env section</span>

<span class="c"># checkout publish branch</span>
git branch <span class="nt">-D</span> master
git checkout <span class="nt">-b</span> master

<span class="c"># ... build site section</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Travis is in the <code class="highlighter-rouge">master</code> branch and has build the site in <code class="highlighter-rouge">output_prod</code> now.
Git can make this output directory the new root of the branch using the <code class="highlighter-rouge">git
filter-branch</code> command. Before executing this, Travis has to commit the
currently added files (the <code class="highlighter-rouge">output_prod</code> directory):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c"># .travis.yml</span>

<span class="c"># ... configure env, checkout publish branch and build site sections</span>

<span class="c"># commit build</span>
git add <span class="nt">-f</span> output_prod
git commit <span class="nt">-m</span> <span class="s2">"Build website"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="highlighter-rouge">-f</code> is required, as output directories are in the <code class="highlighter-rouge">.gitignore</code> file of
a common Sculpin blog. Now, execute the <code class="highlighter-rouge">git filter-branch</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># .travis.yml</span>

<span class="c"># ...</span>

<span class="c"># only commit output dir</span>
git filter-branch <span class="nt">--subdirectory-filter</span> output_prod/ <span class="nt">-f</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="pushing-the-result">
        
        
          <a href="#pushing-the-result" class="section-link"></a> Pushing the Result
        
        
      </h2>

<p>The branch is ready to be pushed back to GitHub, so let’s do that!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># .travis.yml</span>

<span class="c"># ...</span>

<span class="c"># push to GitHub Pages</span>
git push <span class="s2">"https://github.com/WouterJ/wouterj.github.com"</span> <span class="nt">-f</span> master
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Wait a moment… It needs either a username and password or a GitHub token in
order to push. This means that everyone can see my GitHub token. That’s a huge
security leak!</p>

<p>Fortunately, Travis allows you to encrypt the token in a special way that only
works for your repository. This way, you’re the only person who can use this
token. Download the <a href="https://github.com/travis-ci/travis.rb">Travis command line app</a> and use the <code class="highlighter-rouge">travis encrypt</code>
command to encrypt your public token to an environment variable:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>travis encrypt <span class="nt">--add</span> <span class="nv">GH_TOKEN</span><span class="o">=</span>XXX
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(<code class="highlighter-rouge">XXX</code> is your github token here).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[caution]
Be sure to execute this when your in the directory of your blog repository.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As the <code class="highlighter-rouge">--add</code> option was added, the encrypted string is added to your
<code class="highlighter-rouge">.travis.yml</code> configuration. Using this directly like
<code class="highlighter-rouge">git push http://$GH_TOKEN@github.com/...</code> will still show your github token in
the output of the command. You have to put it in the <code class="highlighter-rouge">~/.netrc</code> of the Linux
environment before executing this command. This file is used by Linux to
authenticate with ssh servers.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># .travis.yml</span>

<span class="c1"># ...</span>
<span class="na">before_install</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">echo -e "machine github.com\n  login $GH_TOKEN" &gt;&gt; ~/.netrc</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="round-up">
        
        
          <a href="#round-up" class="section-link"></a> Round Up
        
        
      </h2>

<p>Congrats, you have a running Sculpin blog on GitHub Pages using automatic
buildings with Travis! Everytime you push to your blog’s <code class="highlighter-rouge">source</code> branch, the
site will be regenerated. There are even more nice features:</p>

<ul>
  <li>You get a notification when the build failed</li>
  <li>The output is never pushed when the build failed, meaning you always have a
working site</li>
</ul>

<p>You can see the complete files in <a href="https://github.com/WouterJ/wouterj.github.com">the repository of this site</a>.</p>

        </div>
    </div>
</article>

    </main><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2022 Wouter de Jong</p>
</footer>
</body>

</html>
