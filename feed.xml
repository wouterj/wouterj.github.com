<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.7">Jekyll</generator><link href="https://wouterj.nl/feed.xml" rel="self" type="application/atom+xml" /><link href="https://wouterj.nl/" rel="alternate" type="text/html" /><updated>2024-08-16T13:07:05+00:00</updated><id>https://wouterj.nl/feed.xml</id><title type="html">Wouter J</title><author><name>Wouter de Jong</name></author><entry><title type="html">Store Code Discussions in Git using Git Notes</title><link href="https://wouterj.nl/2024/08/git-notes" rel="alternate" type="text/html" title="Store Code Discussions in Git using Git Notes" /><published>2024-08-08T00:00:00+00:00</published><updated>2024-08-08T00:00:00+00:00</updated><id>https://wouterj.nl/2024/08/git-notes</id><content type="html" xml:base="https://wouterj.nl/2024/08/git-notes"><![CDATA[<p>Code discussions contain relevant information. Isn’t it a shame that we
keep these in the centralized GitHub/GitLab servers, far away from our
decentralized Git code? As soon as we move provider, we’ll lose all old
discussions! And how do you ever find the pull requests back from 5
years ago? Symfony has implemented a lightweight solution to this problem
years ago using a less-known feature of Git: Git Notes.</p>

<h2 id="git-notes">Git Notes?</h2>

<p>Meet one of Git’s unknown features: <a href="https://git-scm.com/docs/git-notes">Git notes</a>. They are hard
to discover… and hard to use. Yet, they provide an interesting feature:
Adding extra information to a commit, after you’ve created it.</p>

<aside class="side" data-type="Git garbage collection">
  <p>Git doesn’t immediately remove objects after a new commit replaced them.
Often, you can still find a “deleted” commit as long as you know its hash
(even on GitHub/GitLab servers). A separate process, called <a href="https://git-scm.com/docs/git-gc">garbage
collection</a>, removes old unused objects. This is often run
automatically every once in a while.</p>

</aside>

<p>Git stores all data using immutable objects. This means that you cannot
change the objects after creation. For instance, when you change a commit’s
message, Git will create a new object and remove the previous one. Git
notes are useful when you want to preserve the existing Git object, but
want to add extra data. Git notes have a many-to-one relationship with
objects: one Git object (commit) can have multiple Git notes references it.</p>

<p>Enough talking, let’s see it in practice!</p>

<p>First, create a commit:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git commit --allow-empty -m </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">Playing with Git notes</span><span style="color: #999999">&quot;</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">[main a63c1ff] Playing with Git notes</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB"> Date: Mon Jul 8 21:18:00 2024 +0200</span></span></code></pre>
</div>

<p>Now, we can add a note to this commit using the <code class="highlighter-shiki">git notes</code> command:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># &#39;a63c1ff&#39; is the object (commit) to attach this note, it defaults</span></span>
<span class="line" data-linenr="2"><span style="color: #6B90C0; font-style: italic"># to HEAD (i.e. the latest commit on the current branch)</span></span>
<span class="line" data-linenr="3"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git notes add -m </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">Extra information of this commit</span><span style="color: #999999">&quot;</span><span style="color: #D8DEE9"> a63c1ff</span></span></code></pre>
</div>

<p>Great, we’ve added extra information to that commit! Now, we can view it by
using the <code class="highlighter-shiki">--notes</code> option:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git log --notes</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">commit a63c1ffcf90a6ee3188a086b14eebf33087aebaa (HEAD -&gt; main)</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">Author: Wouter de Jong &lt;wouter@example.com&gt;</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">Date:   Mon Jul 8 21:18:00 2024 +0200</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    Playing with Git notes</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">Notes:</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    Extra information of this commit</span></span></code></pre>
</div>

<p>Cool! As you can see, the commit object didn’t change (the hash is the same
as before), but we’ve attached the new note object.</p>

<h3 id="multiple-git-notes-references">Multiple Git Notes References</h3>

<p>By default, notes are stored in the <code class="highlighter-shiki">notes/commits</code> ref. But you can
categorize Git notes into multiple references, allowing you to add multiple
types of notes to a single commit.</p>

<p>You can use the <code class="highlighter-shiki">--ref</code> option to specify the note tree:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git notes --ref=acceptance add -m </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">Tested-by: Jane doe &lt;jane@example.com&gt;</span><span style="color: #999999">&quot;</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git log --notes=acceptance</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">commit a63c1ffcf90a6ee3188a086b14eebf33087aebaa (HEAD -&gt; main)</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">Author: Wouter de Jong &lt;wouter@example.com&gt;</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">Date:   Mon Jul 8 21:18:00 2024 +0200</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    Playing with Git notes</span></span>
<span class="line" data-linenr="8"></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">Notes (acceptance):</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    Tested-by: Jane doe &lt;jane@example.com&gt;</span></span></code></pre>
</div>

<p>The <code class="highlighter-shiki">ref/notes/acceptance</code> now holds this new note. Using multiple
references allows us to add multiple notes to a single commit (one per
reference):</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git log --notes=commits --notes=acceptance</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">commit a63c1ffcf90a6ee3188a086b14eebf33087aebaa (HEAD -&gt; main)</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">Author: Wouter de Jong &lt;wouter@example.com&gt;</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">Date:   Mon Jul 8 21:18:00 2024 +0200</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    Let&#39;s use Git notes</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">Notes:</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    Extra information for this commit</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">Notes (acceptance):</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    Tested-by: Jane doe &lt;jane@example.com&gt;</span></span></code></pre>
</div>

<aside class="side" data-type="Git Notes in practise">
  <p>Git developers use notes to store references to their mailing list like
<code class="highlighter-shiki">Message-Id: &lt;1264640755-22447-1-git-send-email-szeder@ira.uka.de&gt;</code>.</p>

  <p>You can also use notes to store other information, such as who reviewed or
tested a commit. <a href="https://gerrit.googlesource.com/plugins/reviewnotes/+/refs/heads/master/src/main/resources/Documentation/refs-notes-review.md">The reviewnotes documentation</a> shows some
examples.</p>

</aside>

<h2 id="how-symfony-uses-git-notes-to-store-github-discussions">How Symfony uses Git Notes to store GitHub Discussions</h2>

<p>Now we know a bit about Git notes, we can look at how we can use them to
store code discussions and reviews.</p>

<p>Symfony maintainers use an internal CLI tool to merge contributions. Among
other things it checks CI and core team approvals, and it helps us
automatically re-target contributions to the correct version.</p>

<p>After merging a branch using Git, the tool also uses the GitHub API to
fetch all pull request comments. The comments are stored in a Git Note and
attached to the merge commit. This way, whenever you need to find the
discussion for a particular feature, you can look up the merge commit and
read it. Even if Symfony decides to switch to another platform one day.</p>

<h3 id="storing-github-comments-in-a-note">Storing GitHub Comments in a Note</h3>

<p>First, the tool fetches the pull request comments using the <a href="https://github.com/KnpLabs/php-github-api/">GitHub API</a>
via the <a href="https://github.com/KnpLabs/php-github-api/">KnpLabs GitHub API package</a>:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> GitHub</span><span style="color: #999999">\</span><span style="color: #C7C8D2">Client</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">github</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Client</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">resultPager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">ResultPager</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">github</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">prComments</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">resultPager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">fetchAll</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">github</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">issues</span><span style="color: #999999">()</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">comments</span><span style="color: #999999">(),</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">all</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">symfony</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">symfony</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">prNumber</span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="10"><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>Then, it loops over all comments and puts it in a temporary file:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">notes</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;&#39;</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">foreach</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">prComments</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">as</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">comment</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">notes</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">.=</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&lt;&lt;&lt;</span><span style="color: #E5673D">EOF</span></span>
<span class="line" data-linenr="4"><span style="color: #7CC64A">---------------------------------------------------------------------------</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #7CC64A">by </span><span style="color: #E5673D">{$</span><span style="color: #D8DEE9">comment</span><span style="color: #999999">[&#39;</span><span style="color: #7CC64A">user</span><span style="color: #999999">&#39;][&#39;</span><span style="color: #7CC64A">login</span><span style="color: #999999">&#39;]</span><span style="color: #E5673D">}</span><span style="color: #7CC64A"> at </span><span style="color: #E5673D">{$</span><span style="color: #D8DEE9">comment</span><span style="color: #999999">[&#39;</span><span style="color: #7CC64A">created_at</span><span style="color: #999999">&#39;]</span><span style="color: #E5673D">}</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #E5673D">{$</span><span style="color: #D8DEE9">comment</span><span style="color: #999999">[&#39;</span><span style="color: #7CC64A">body</span><span style="color: #999999">&#39;]</span><span style="color: #E5673D">}</span></span>
<span class="line" data-linenr="9"></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #7CC64A">    </span><span style="color: #E5673D">EOF</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="12"><span style="color: #999999">}</span></span>
<span class="line" data-linenr="13"></span>
<span class="line" data-linenr="14"><span style="color: #C7C8D2">file_put_contents</span><span style="color: #999999">(</span><span style="color: #C7C8D2">getcwd</span><span style="color: #999999">()</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">/.notes</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">notes</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>Now, we can create a Git note from the file contents (Symfony puts them in
a named “github-comments” reference):</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># first, replace the local github-comments ref with the upstream one</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git fetch origin refs/notes/github-comments:refs/notes/github-comments</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #6B90C0; font-style: italic"># then, create the new note</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git notes --ref=github-comments add --file=.notes</span></span></code></pre>
</div>

<p>Finally, we can push the notes to GitHub. Git doesn’t push notes by
default, we have to mention the reference explicitly:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git push --no-follow-tags origin refs/notes/github-comments</span></span></code></pre>
</div>

<aside class="side" data-type="Distributed Code Reviews">
  <p>This implementation only distributes the code discussions together with the
code.</p>

  <p>Some developers at Google took the concept one level further and created
<a href="https://github.com/google/git-appraise">Git Appraise</a>, a distributed code review implementation
(including requesting and reviewing itself).</p>

</aside>

<h3 id="reading-the-notes-back">Reading the Notes back</h3>

<p>GitHub no longer shows the <code class="highlighter-shiki">refs/notes/...</code> objects anywhere. But as it is
just another set of objects (just like the commit tree), you can still
push and fetch it from GitHub if you reference it directly:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git fetch origin refs/notes/github-comments:refs/notes/github-comments</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># or fetch all note references</span></span>
<span class="line" data-linenr="4"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git fetch origin </span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">refs/notes/*:refs/notes/*</span><span style="color: #999999">&quot;</span></span></code></pre>
</div>

<p>You can also edit the <code class="highlighter-shiki">.git/config</code> file of a project to always fetch
notes by default:</p>

<div class="language-diff highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">  [remote &quot;origin&quot;]</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">    fetch = +refs/heads/*:refs/remotes/origin/*</span></span>
<span class="line" data-linenr="3"><span style="color: #999999">+</span><span style="color: #7CC64A">   fetch = +refs/notes/*:refs/notes/*</span></span></code></pre>
</div>

<p>Now the notes exist locally, you can view them in the Git logs for instance:</p>

<div class="language-terminal highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #999999">$ </span><span style="color: #D8DEE9">git log --notes=github-comments</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">commit 1a16ebc32598faada074e0af12a6a698d2964a5e (HEAD -&gt; 7.2, origin/7.2)</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">Merge: 09f9eb73b6 1303cd1a56</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">Author: Nicolas Grekas &lt;nicolas.grekas@gmail.com&gt;</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">Date:   Wed Jul 10 17:23:17 2024 +0200</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    minor #57657 [Messenger] [SQS] Allow to pass `sslmode` as an option (spuf)</span></span>
<span class="line" data-linenr="8"></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    This PR was merged into the 7.2 branch.</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">    Discussion</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    ----------</span></span>
<span class="line" data-linenr="13"></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    [Messenger] [SQS] Allow to pass `sslmode` as an option</span></span>
<span class="line" data-linenr="15"></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    | Q             | A</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">    | ------------- | ---</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">    | Branch?       | 7.2</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">    | Bug fix?      | no</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">    | New feature?  | no</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">    | Deprecations? | no</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">    | Issues        |</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    | License       | MIT</span></span>
<span class="line" data-linenr="24"></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">    This is a minor. There is an option &quot;sslmode&quot; that is documented as an option but can be passed only in dsn query string.</span></span>
<span class="line" data-linenr="26"></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">    Commits</span></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">    -------</span></span>
<span class="line" data-linenr="29"></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">    1303cd1a56 [Messenger][SQS] Allow to pass sslmode as an option</span></span>
<span class="line" data-linenr="31"></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">Notes (github-comments):</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">    ---------------------------------------------------------------------------</span></span>
<span class="line" data-linenr="34"></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">    by carsonbot at 2024-07-04T20:10:34Z</span></span>
<span class="line" data-linenr="36"></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">    Hey!</span></span>
<span class="line" data-linenr="38"></span>
<span class="line" data-linenr="39"><span style="color: #BBBBBB">    I see that this is your first PR. That is great! Welcome!</span></span>
<span class="line" data-linenr="40"></span>
<span class="line" data-linenr="41"><span style="color: #BBBBBB">    ...</span></span></code></pre>
</div>

<h2 id="summary">Summary</h2>

<ul>
  <li>It’s important to distribute more than just the code</li>
  <li>Use Git notes to store all sorts of important information to commits</li>
  <li>You can view old Symfony discussions offline by using the
<code class="highlighter-shiki">github-comments</code> notes reference</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="documentation" /><summary type="html"><![CDATA[Code discussions contain relevant information. Isn’t it a shame that we keep these in the centralized GitHub/GitLab servers, far away from our decentralized Git code? As soon as we move provider, we’ll lose all old discussions! And how do you ever find the pull requests back from 5 years ago? Symfony has implemented a lightweight solution to this problem years ago using a less-known feature of Git: Git Notes.]]></summary></entry><entry><title type="html">Combatting Login CSRF with Symfony</title><link href="https://wouterj.nl/2023/10/combatting-login-csrf-with-symfony" rel="alternate" type="text/html" title="Combatting Login CSRF with Symfony" /><published>2023-10-19T00:00:00+00:00</published><updated>2023-10-19T00:00:00+00:00</updated><id>https://wouterj.nl/2023/10/combatting-login-csrf-with-symfony</id><content type="html" xml:base="https://wouterj.nl/2023/10/combatting-login-csrf-with-symfony"><![CDATA[<p>Cross-site Request Forgery (CSRF) is one of the traditional vulnerabilities
that web applications have to deal with. Every web framework - including
Symfony - supports CSRF protection out of the box. A lesser known
vulnerability is <em>Login CSRF</em>, a special kind of CSRF attack.</p>

<h2 id="how-a-csrf-attack-works">How a CSRF Attack Works</h2>

<p>A <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">CSRF attack</a> takes advantage of the sessions in the browser. If you
login to a website, your authentication token is stored in a session. This
means that you’re still logged in if you switch to another page of the
website.</p>

<p>The browser also remembers this session when visiting other websites. This
is nice, as it allows you to go back to the website and still be logged in.
However, attackers are using this to make requests from their website to
your website using the remembered authentication session. This means that,
without CSRF protection, it can use your website as if it was the user.</p>

<p>For instance, an attacker can trick the user into thinking they are on your
website and show them a form that looks like the login:</p>

<div class="language-html highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">&lt;form</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">action</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">https://yourwebsite.com/profile/change_password</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">method</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">POST</span><span style="color: #999999">&quot;</span><span style="color: #E5673D">&gt;</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">&lt;label&gt;</span><span style="color: #BBBBBB">Username </span><span style="color: #E5673D">&lt;input</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">type</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">text</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">name</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">username</span><span style="color: #999999">&quot;</span><span style="color: #E5673D">&gt;&lt;/label&gt;</span></span>
<span class="line" data-linenr="3"></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">&lt;label&gt;</span><span style="color: #BBBBBB">Password </span><span style="color: #E5673D">&lt;input</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">type</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">name</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">current_password</span><span style="color: #999999">&quot;</span><span style="color: #E5673D">&gt;&lt;/label&gt;</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">&lt;input</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">type</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">hidden</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">name</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">new_password</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">value</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">...</span><span style="color: #999999">&quot;</span><span style="color: #E5673D">&gt;</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">&lt;button</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">type</span><span style="color: #999999">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">submit</span><span style="color: #999999">&quot;</span><span style="color: #E5673D">&gt;</span><span style="color: #BBBBBB">Login</span><span style="color: #E5673D">&lt;/button&gt;</span></span>
<span class="line" data-linenr="9"><span style="color: #E5673D">&lt;/form&gt;</span></span></code></pre>
</div>

<p>In reality (looking at the <code class="highlighter-shiki">action</code> and <code class="highlighter-shiki">type=&quot;hidden&quot;</code> input), this form
changes the password of the user to something that is known only by the
attacker, giving them access to their account. Attacks can also do any
other action on your website, like buying goods or transfering money to
their account.</p>

<h2 id="how-login-csrf-attacks-are-different">How Login CSRF Attacks are Different</h2>

<p>The CSRF attacks described above are <em>using the authenticated session</em> to
act as a user. <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#login-csrf">Login CSRF attacks</a> are the opposite: they <em>force an
authenticated session</em> to let the user act as them.</p>

<p>How does that work? When someone visits the website of an attacker, they
make a request to <code class="highlighter-shiki">yourwebsite.com/logout</code> to force an unauthenticated
session and then make a request to <code class="highlighter-shiki">yourwebsite.com/login</code> with
credentials of an account that they control.</p>

<aside class="side" data-type="side note">
  <p>With the introduction of <code class="highlighter-shiki">Secure</code> and <code class="highlighter-shiki">SameSite</code> cookie flags, there has
been a feeling that <a href="https://scotthelme.co.uk/csrf-is-really-dead/">CSRF is dead</a>. Login CSRF is a good example of a
situation where these cookie flags won’t protect your users against a CSRF
attack. While the web is more secure thanks to these cookie flags, CSRF
still has its function in modern web applications.</p>
</aside>

<p>This can have serious consequences for the user, depending on the
functionality of your website. E.g. <a href="https://seclab.stanford.edu/websec/csrf/csrf.pdf">“Robust Defenses for Cross-Site Request
Forgery” (Barth, Jackson, Mitchell, 2008)</a> mention that this attack is
used to let users unknowingly connect their creditcard to the PayPal
account of the attacker. It is also used to get access to a user’s Google
account, or using it to track the user’s search terms and locations.</p>

<p>The risk of Login CSRF attacks is often considered to be lower. Most users
are expected to notice when they are logged in to someone else’s account on
the website (hence it’s a good idea to make this visible on all pages!).
However, the consequences can be very high when a user doesn’t notice. If
you’re using Symfony, protecting against them is very easy and I would
recommend always doing this.</p>

<h2 id="protecting-against-login-csrf">Protecting against Login CSRF</h2>

<p>A login CSRF attack can include two steps: first a call to logout to force
the website in a known state, and then a login with the attackers
credentials. Let’s protect both steps!</p>

<h3 id="protecting-login">Protecting Login</h3>

<p>Protecting against login CSRF attacks is similar to protecting against
other CSRF attacks. When rendering the login form, you create a randomized
token which you submit along with the rest of the form. When handling the
submission, this token is checked for validity.</p>

<p>When using Symfony’s built-in <code class="highlighter-shiki">form_login</code> authenticator, generating and
validating this randomized token is mostly automated for you. First, enable
CSRF protection in the authenticator:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #C7C8D2">security</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">firewalls</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">main</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">form_login</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">                </span><span style="color: #C7C8D2">enable_csrf</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span></code></pre>
</div>

<p>And then, add a hidden CSRF token to your login form template:</p>

<div class="language-twig highlighter-shiki"><pre class="shiki-gutter">1
2
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">&lt;!-- csrf_token() takes care of correctly generating and storing the CSRF token --&gt;</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">&lt;input</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">type</span><span style="color: #BBBBBB">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">hidden</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">name</span><span style="color: #BBBBBB">=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">_csrf_token</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">value</span><span style="color: #BBBBBB">=</span><span style="color: #999999">&quot;{{</span><span style="color: #7CC64A"> </span><span style="color: #C7C8D2">csrf_token</span><span style="color: #999999">(&#39;</span><span style="color: #7CC64A">authenticate</span><span style="color: #999999">&#39;)</span><span style="color: #7CC64A"> </span><span style="color: #999999">}}&quot;</span><span style="color: #E5673D">&gt;</span></span></code></pre>
</div>

<p>That’s it! Your users are safe against this attack now!</p>

<p>When you’re using a custom login form authenticator, you’ll have to add
<a href="https://symfony.com/doc/current/security/custom_authenticator.html#passport-badges">the <code class="highlighter-shiki">CsrfTokenBadge</code></a> with the CSRF token from the request. The
security system will then validate this token for you.</p>

<h3 id="protecting-logout">Protecting Logout</h3>

<aside class="side" data-type="Symfony &lt;6.2">
  <p>The <code class="highlighter-shiki">enable_csrf</code> option is new in Symfony 6.2. If you’re stuck on
an older version, you need to use <code class="highlighter-shiki">csrf_token_generator: security.csrf.token_manager</code>
instead. Read more about it in <a href="https://symfony.com/doc/5.4/reference/configuration/security.html#reference-security-logout-csrf">the documentation</a>.</p>
</aside>

<p>You can protect logout in a similar way by enabling CSRF protection in the
config:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #C7C8D2">security</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">firewalls</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">main</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">logout</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">                </span><span style="color: #C7C8D2">enable_csrf</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span></code></pre>
</div>

<p>If you’re already using the <code class="highlighter-shiki">logout_path()</code> Twig helper function to
generate a URL to your logout route, this is all you had to do! The Twig
function generates a unique CSRF token and attaches it to the URL.</p>

<p>Otherwise, replace links to the logout page with this Twig function in your
Twig templates:</p>

<div class="language-twig highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">&lt;a</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">href</span><span style="color: #BBBBBB">=</span><span style="color: #999999">&quot;{{</span><span style="color: #7CC64A"> logout_path</span><span style="color: #999999">()</span><span style="color: #7CC64A"> </span><span style="color: #999999">}}&quot;</span><span style="color: #E5673D">&gt;</span><span style="color: #BBBBBB">Logout</span><span style="color: #E5673D">&lt;/a&gt;</span></span></code></pre>
</div>

<h2 id="take-homes">Take Homes</h2>

<ul>
  <li>Make sure your login/logout actions are also protected against CSRF
attacks</li>
  <li>While cookies have become more secure in recent years, CSRF protection
still needs attention</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><summary type="html"><![CDATA[Cross-site Request Forgery (CSRF) is one of the traditional vulnerabilities that web applications have to deal with. Every web framework - including Symfony - supports CSRF protection out of the box. A lesser known vulnerability is Login CSRF, a special kind of CSRF attack.]]></summary></entry><entry><title type="html">Using the SecurityBundle in Symfony 6</title><link href="https://wouterj.nl/2021/12/security-winterworld21" rel="alternate" type="text/html" title="Using the SecurityBundle in Symfony 6" /><published>2021-12-10T00:00:00+00:00</published><updated>2021-12-10T00:00:00+00:00</updated><id>https://wouterj.nl/2021/12/security-winterworld21</id><content type="html" xml:base="https://wouterj.nl/2021/12/security-winterworld21"><![CDATA[<p>At SymfonyWorld Winter 2021, I talked about using the new Symfony
authentication system in your applications in Symfony 6. We discussed
the important changes to the Security component, what we tried to
improve with each change, and how you can use these to make a more
secure application quicker.</p>

<embed src="/assets/uploads/sfwinterworld21-talk.pdf" class="post__slides" />

<h2 id="references--features">References &amp; Features</h2>

<ul>
  <li>The security makers in <a href="https://symfony.com/bundles/SymfonyMakerBundle/current/index.html">Symfony MakerBundle</a></li>
  <li><a href="https://symfony.com/doc/current/security/#the-user">Minimalized <code class="highlighter-shiki">UserInterface</code></a></li>
  <li>SymfonyCasts <a href="https://github.com/SymfonyCasts/verify-email-bundle">VerifyEmailBundle</a>
and <a href="https://github.com/SymfonyCasts/reset-password-bundle">ResetPasswordBundle</a></li>
  <li>Built-in <a href="https://symfony.com/doc/current/security/#form-login">form login authenticator</a> and
<a href="https://symfony.com/doc/current/security/#json-login">json login authenticator</a>
(<a href="https://symfony.com/doc/current/security.html#authenticating-users">all built-in authenticators</a>)</li>
  <li>The new Security profiler</li>
  <li><a href="https://github.com/lexik/LexikJWTAuthenticationBundle">LexikJWTAuthenticationBundle</a>,
<a href="https://github.com/hslavich/OneloginSamlBundle">OneloginSamlBundle</a>,
<a href="https://github.com/web-auth/webauthn-symfony-bundle">WebauthnSymfonyBundle</a>,
<a href="https://github.com/knpuniversity/oauth2-client-bundle">KnpUOauth2ClientBundle</a> and
<a href="https://symfony.com/bundles/SchebTwoFactorBundle/current/index.html">SchebTwoFactorBundle</a></li>
  <li>The new <a href="https://symfony.com/doc/current/security/#security-events">Security event cycle</a></li>
  <li>The new <a href="https://symfony.com/blog/new-in-symfony-5-4-profiler-improvements#more-security-information-in-the-profiler"><code class="highlighter-shiki">debug:firewall</code> command</a></li>
  <li>Symfony <a href="https://symfony.com/doc/current/security/custom_authenticator.html#security-passport">security Passports</a></li>
  <li>The new <code class="highlighter-shiki">required_badges</code> setting</li>
  <li>Implementing <a href="https://symfony.com/doc/current/security/custom_authenticator.html">custom authenticators</a></li>
  <li><a href="https://symfony.com/doc/5.2/security/experimental_authenticators.html">Using the new authentication system in Symfony 5</a></li>
  <li>All code of this talk in an example application: <a href="https://github.com/wouterj-nl/security-winterworld21">https://github.com/wouterj-nl/security-winterworld21</a></li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="talk" /><category term="symfony" /><summary type="html"><![CDATA[At SymfonyWorld Winter 2021, I talked about using the new Symfony authentication system in your applications in Symfony 6. We discussed the important changes to the Security component, what we tried to improve with each change, and how you can use these to make a more secure application quicker.]]></summary></entry><entry><title type="html">Deprecations are not like E_ERROR, E_WARNING, and E_NOTICE</title><link href="https://wouterj.nl/2021/11/deprecations-are-not-errors" rel="alternate" type="text/html" title="Deprecations are not like E_ERROR, E_WARNING, and E_NOTICE" /><published>2021-11-13T00:00:00+00:00</published><updated>2021-11-13T00:00:00+00:00</updated><id>https://wouterj.nl/2021/11/deprecations-are-not-errors</id><content type="html" xml:base="https://wouterj.nl/2021/11/deprecations-are-not-errors"><![CDATA[<p>Every now and then, there seems to be a lot of fuss in the PHP community
about deprecations. In these discussions, deprecations are often
discussed as if they are fatal errors. I think that is very wrong. Let’s
reduce our expectations of deprecations. It’ll make everyones live much
less stressful.</p>

<h2 id="why-we-were-afraid-of-change-in-the-past">Why we were Afraid of Change in the Past</h2>

<aside class="side" data-type="side note">
  <p>I can’t think of a world without deprecations and backwards
compatibility nowadays. The PHP community has matured fast. The
semantic versioning specification, which I think has ignited the
backwards compatibility movement, was published only 8 years ago
in 2013. In this same year, Symfony triggered its first ever deprecation
notice.</p>
</aside>

<p>In the past, the only way to know about a change in the next version was
by reading the CHANGELOGs. Every change required you to manually check
if your code was affected.</p>

<p>Mind you, even Composer was not a thing 8 years ago. Most applications
would just copy past the vendor code in their project (sometimes even
altering code in the vendor).</p>

<p>This took time, a lot of time. As a consequence, languages and
libraries were very restricted in how they could evolve.</p>

<h2 id="why-php-developers-are-afraid-of-any-e_-being-reported">Why PHP Developers are Afraid of any <code class="highlighter-shiki">E_*</code> being Reported</h2>

<p>PHP had a habit of trying to “fix” incorrect code. Forgot the quotes
around a string? No worries, <a href="https://3v4l.org/m0l3p">PHP still interpreted it as a
string</a> if the constant wasn’t found. It
triggered an <code class="highlighter-shiki">E_NOTICE</code> to let you know that PHP found something
unexpected but tried to continue.</p>

<p>This can produce unexpected behavior (e.g. what if you meant a constant,
but you made a typo?). As a result, PHP developers have become extremely
careful with anything being reported. Even though it’s not a direct fatal
error, many of us correctly consider notices to be something that must
be fixed.</p>

<p>However, this also makes us very careful with <code class="highlighter-shiki">E_DEPRECATED</code>. After all,
it’s reported and it starts with <code class="highlighter-shiki">E_</code>. That MUST be fixed as soon as
possible, right? …right?</p>

<h2 id="why-deprecations-are-different">Why Deprecations are Different</h2>

<p>Deprecations are not like notices, warnings or errors. Deprecations are
the cornerstone in <em>smooth upgrade paths</em>. This smooth upgrade path
contains a couple steps:</p>

<ol>
  <li>A contributor makes a backwards compatibility breaking change</li>
  <li>The contributor introduces a “BC layer” to make sure the old API
also works. This “BC layer” triggers a deprecation, notifying that
you’re using a legacy API</li>
  <li>In the next major version, a maintainer removes the “BC layer” and
the new API is the only available API</li>
</ol>

<p>This means that a <em>user</em> can use the old API as long as they want, until
they want to upgrade to the next major version.</p>

<aside class="side" data-type="side note">
  <p>The smooth upgrade path is such an improvement that most maintainers
have to get used to it. Most developers love refactoring legacy bits,
and I think it’s normal to “overshoot” it at first. Maintainers will
learn from this (I’m sure the hard upgrade from Symfony 3.4 is not
repeated again).</p>

  <p>Give them constructive feedback on what made an upgrade hard for your
applications. Don’t judge them for making changes, help them improve
further changes.</p>
</aside>

<p>A deprecation is a major help for us <em>users</em>. Instead of being notified
only after the major release (by reading the CHANGELOG), we get notified
years or months in advance. For instance, you have at least 3 years to
fix any deprecation that Symfony gives you.</p>

<h2 id="you-dont-have-to-run-deprecation-free">You don’t have to run Deprecation-free</h2>

<p>Using a deprecated feature doesn’t result in unpredictable behavior,
like PHP’s notices do. They don’t signal a bug, like warnings and errors
do. They just tell you that you have some work to do before upgrading to
the next major version. That’s all!</p>

<p>With deprecations, you can prioritize upgrade work and reserve some time
for it in a 2 or 3 year timespan. Backwards compatibility breaks are no
longer ad-hoc tasks, they become plannable tasks.</p>

<p>Is your business busy the next few months? Fine! Your apps remain
running with tons of deprecations for months to come. There will always
be a boring week in the summer break were you can fix a couple
deprecations.</p>

<p>Most often, when a new deprecation is introduced, the major version is not
even being worked on. For instance, if PHP triggers a deprecation now,
you’re notified of a breaking change in PHP 9. Do you know the release
date of PHP 9? I don’t (probably one or two years from now?). Is it
really worth worrying so much today about a breaking change in an
unknown future?</p>

<h2 id="dont-judge-your-vendor-code-for-not-running-deprecation-free">Don’t Judge your Vendor Code for not running Deprecation-free</h2>

<p>The same applies to any vendor code that your app is using. Getting
deprecation notices from a vendor library? That’s fine. You can reserve
some time and contribute a fix for one or two deprecations to the open
source project.</p>

<p>If we all do it, the open source project will support the new major
version months before it’s even released.</p>

<h2 id="how-to-hide-and-log-deprecations">How to Hide and Log Deprecations</h2>

<p>If you are using the default PHP error handler, you’re left to either
hide deprecations or output them like all other errors. Symfony has a
small <a href="https://github.com/symfony/error-handler"><code class="highlighter-shiki">symfony/error-handler</code></a>
package that allows you to register <a href="https://php-fig.org/psr/psr-3/">PSR-3 loggers</a>
for a specific error level. Besides, it automatically hides
deprecations from the normal output.</p>

<p>Using this code, all deprecations are logged to <code class="highlighter-shiki">deprecation.log</code> and
the normal error handler is used for all other errors:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">&lt;?</span><span style="color: #BBBBBB">php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">require_once</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">vendor/autoload.php</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Psr</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Log</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AbstractLogger</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">ErrorHandler</span><span style="color: #999999">\</span><span style="color: #C7C8D2">ErrorHandler</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #C7C8D2">ErrorHandler</span><span style="color: #E5673D">::</span><span style="color: #C7C8D2">register</span><span style="color: #999999">()</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">setDefaultLogger</span><span style="color: #999999">(</span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AbstractLogger</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">log</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">level</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">string</span><span style="color: #999999">|\</span><span style="color: #C7C8D2">Stringable</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">message</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">array</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">context</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[])</span><span style="color: #E5673D">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">void</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">        </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">formattedLogLine</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">sprintf</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="13"><span style="color: #C7C8D2">                </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">[%s] %s: %s%s</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">.</span><span style="color: #E5673D">PHP_EOL</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="14"><span style="color: #C7C8D2">                date</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">Y-m-dTH:i:s.uP</span><span style="color: #999999">&#39;</span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="15"><span style="color: #C7C8D2">                </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">level</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="16"><span style="color: #C7C8D2">                </span><span style="color: #999999">(</span><span style="color: #E5673D">string</span><span style="color: #999999">)</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">message</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="17"><span style="color: #C7C8D2">                </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">context</span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">exception</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">??</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">false</span><span style="color: #999999">)</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">instanceof</span><span style="color: #C7C8D2"> </span><span style="color: #999999">\</span><span style="color: #C7C8D2">Throwable</span></span>
<span class="line" data-linenr="18"><span style="color: #C7C8D2">                    </span><span style="color: #E5673D">?</span><span style="color: #C7C8D2"> </span><span style="color: #C7C8D2">sprintf</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A"> in %s:%s</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">context</span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">exception</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getFile</span><span style="color: #999999">(),</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">context</span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">exception</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getLine</span><span style="color: #999999">())</span></span>
<span class="line" data-linenr="19"><span style="color: #C7C8D2">                    </span><span style="color: #E5673D">:</span><span style="color: #C7C8D2"> </span><span style="color: #999999">&#39;&#39;</span></span>
<span class="line" data-linenr="20"><span style="color: #C7C8D2">            </span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="21"></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">file_put_contents</span><span style="color: #999999">(</span><span style="color: #E5673D">__DIR__</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">/deprecations.log</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">formattedLogLine</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #999999">\</span><span style="color: #E5673D">FILE_APPEND</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="24"><span style="color: #BBBBBB">    </span><span style="color: #999999">},</span><span style="color: #BBBBBB"> </span><span style="color: #999999">\</span><span style="color: #E5673D">E_DEPRECATED</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">|</span><span style="color: #BBBBBB"> </span><span style="color: #999999">\</span><span style="color: #E5673D">E_USER_DEPRECATED</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="25"><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="26"></span>
<span class="line" data-linenr="27"><span style="color: #6B90C0; font-style: italic">// &quot;null&quot; argument deprecated as of PHP 8.1</span></span>
<span class="line" data-linenr="28"><span style="color: #C7C8D2">var_dump</span><span style="color: #999999">(</span><span style="color: #C7C8D2">str_contains</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">foo</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #C7C8D2"> </span><span style="color: #E5673D">null</span><span style="color: #999999">))</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<h2 id="take-homes">Take Home’s</h2>

<ul>
  <li>Don’t try to run deprecation free until you want to upgrade to a new
major</li>
  <li>Don’t judge maintainers triggering deprecations, thank them for
letting you know about a big change way in advance</li>
  <li>Deprecations make upgrade tasks plannable, instead of ad-hoc</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="backwards-compatibility" /><summary type="html"><![CDATA[Every now and then, there seems to be a lot of fuss in the PHP community about deprecations. In these discussions, deprecations are often discussed as if they are fatal errors. I think that is very wrong. Let’s reduce our expectations of deprecations. It’ll make everyones live much less stressful.]]></summary></entry><entry><title type="html">Symfony 6: PHP 8 Native Types &amp;amp; Why we Need YOU</title><link href="https://wouterj.nl/2021/09/symfony-6-native-typing" rel="alternate" type="text/html" title="Symfony 6: PHP 8 Native Types &amp;amp; Why we Need YOU" /><published>2021-09-10T00:00:00+00:00</published><updated>2021-09-10T00:00:00+00:00</updated><id>https://wouterj.nl/2021/09/symfony-6-native-typing</id><content type="html" xml:base="https://wouterj.nl/2021/09/symfony-6-native-typing"><![CDATA[<p>A very exciting time is coming with the biggest change for Symfony since
Symfony 2.0: Symfony 6 has native PHP types on all its methods where it
is possible. This will be a great push towards type safety in the PHP
open source communities! <a href="https://github.com/sponsors/nicolas-grekas">Nicolas</a> and
<a href="https://github.com/derrabus">Alexander</a> have been working on and off for 2 years to create
the best upgrade experience possible.<br />
Now, 2.5 months before the stable release, it is <em>YOUR</em> time to shine!
Especially if you maintain any open source project (not even directly
linked to Symfony), we would love to hear from you to make sure the
upgrade isn’t dramatically hard.</p>

<p>As of Symfony 5.4, the debug class loader (which is used in Symfony
applications in the dev/test env) will check return type compatibility
and warn you if a method is incompatible. Even more… it can fix it
automatically for you! <a href="https://symfony.com/doc/5.4/setup/upgrade_major.html#upgrading-to-symfony-6-add-native-return-types">Read more about this feature in the Symfony
docs.</a></p>

<h2 id="symfony-applications-upgrade-plan">Symfony Applications Upgrade Plan</h2>

<p>The upgrade plan is slightly different for open source packages and
applications. This section describes your upgrade plan if you’re
building applications using the Symfony framework (or only some
components).</p>

<p>The techniques and tools created to make this experience as smooth as
possible are brand-new. Please install 5.4-dev now and let us <a href="https://github.com/symfony/symfony/issues/new/choose">know about
any issue</a>.</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ composer config minimum-stability dev</span></span>
<span class="line" data-linenr="2"><span style="color: #6B90C0; font-style: italic"># now, modify all Symfony constraints to &quot;^5.4&quot; in &quot;composer.json&quot;, then:</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">$ composer update </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">symfony/*</span><span style="color: #999999">&#39;</span></span></code></pre>
</div>

<h3 id="when-upgrading-to-symfony-54">When upgrading to Symfony 5.4</h3>

<p>First, upgrade to Symfony 5.4. Besides fixing all “normal” deprecations,
you also need to fix some type declarations.</p>

<p>In PHP, it is possible to define a return type when the parent
declaration doesn’t define it (yet):</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">interface</span><span style="color: #BBBBBB"> UserInterface</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getRoles</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #999999">}</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">User</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserInterface</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// valid!</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">getRoles</span><span style="color: #999999">()</span><span style="color: #E5673D">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">array</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="13"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>At the other hand, you must define a return type if your parent does
(remember, Symfony 6 will define return types!). This means that 5.4 is
your time to add return types to all methods (especially those
overriding or implementing methods from Symfony).</p>

<p>Symfony provides a small utility in the <a href="https://symfony.com/components/ErrorHandler"><code class="highlighter-shiki">symfony/error-handler</code> component</a>
to automatically add the required return types. First, generate a
complete classmap of your application using Composer. Then, run the
utility:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># (1) Make sure &quot;exclude-from-classmap&quot; is not set in your &quot;composer.json&quot;</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic"># (2) Generate the classmap (&quot;-o&quot; is important!)</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">$ composer dump-autoload -o</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #6B90C0; font-style: italic"># (3) Run the patch script</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">$ ./vendor/bin/patch-type-declarations</span></span></code></pre>
</div>

<p>Once you’ve fixed them (and running this script above will do it all for
you), you’re ready to upgrade to Symfony 6!</p>

<h3 id="when-using-symfony-6x">When using Symfony 6.x</h3>

<p>After upgrading to Symfony 6.0, you can start adding parameter types.
Parameter type compatibility is inverted compared to return types: a
child may not set the type if the parent already does, but a child
cannot set the type before the parent:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">interface</span><span style="color: #BBBBBB"> FormTypeGuesserInterface</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">guessType</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">class</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">property</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #999999">}</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">CustomTypeGuesser</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserInterface</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// error!</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">guessType</span><span style="color: #999999">(</span><span style="color: #E5673D">string</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">class</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">string</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">property</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="13"><span style="color: #999999">}</span></span></code></pre>
</div>

<p>For this reason, you cannot add these parameter types in 5.4.</p>

<h2 id="symfony-bundle-maintainers-compatibility-plan">Symfony Bundle Maintainers Compatibility Plan</h2>

<p>Unfortunately, open source maintainers can experience some more trouble
when adding return types. This is because you probably care about not
breaking backwards compatibility. And, as noted before, defining a
return type means all users overriding/implementing the method must
define it as well.</p>

<h3 id="document-the-return-type">Document the Return Type</h3>

<p>First, you can add return types only on safe methods. These are methods
that should not be extended by users of your package. The patch tool
from Symfony defines safe methods as any method that:</p>

<ul>
  <li>Is in the <code class="highlighter-shiki">Tests</code> namespace</li>
  <li>Is <code class="highlighter-shiki">final</code> or <code class="highlighter-shiki">@final</code> (or its class)</li>
  <li>Is <code class="highlighter-shiki">@internal</code> (or its class)</li>
  <li>Is <code class="highlighter-shiki">private</code></li>
</ul>

<p>Use <code class="highlighter-shiki">force=1</code> to only patch types for these safe methods:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic"># you can set the minimum PHP version, e.g. &quot;static&quot; won&#39;t be added</span></span>
<span class="line" data-linenr="2"><span style="color: #6B90C0; font-style: italic"># as a return type for 7.4</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">$ SYMFONY_PATCH_TYPE_DECLARATIONS=</span><span style="color: #999999">&quot;</span><span style="color: #7CC64A">force=1&amp;php=7.4</span><span style="color: #999999">&quot;</span><span style="color: #BBBBBB"> ./vendor/bin/patch-type-declarations</span></span></code></pre>
</div>

<p>Now, you have to check if there are any methods that would produce an
error in Symfony 6. The quickest way to do this is running the same
script again. Any deprecation in the output is an incompatible method.</p>

<p>If you don’t see any deprecation: Congratulations! You are compatible with
Symfony 6 and can allow <code class="highlighter-shiki">^6.0</code> to your Symfony dependencies without having
to break compatibility for your users.</p>

<h3 id="fix-all-return-types">Fix all Return Types</h3>

<p>Some bundles may discover that they need to add return types to methods
that might be overridden or implemented. As this causes a backwards
compatibility break, you probably don’t want to do this in a minor
release.</p>

<p>Instead, make sure you properly document the correct return type using
the <code class="highlighter-shiki">@return</code> PHPDoc. This will create the useful deprecations for your
users to know they have to update their PHP return types. The patch
script can add this PHPDoc for methods that implement/override from
third party classes/interfaces:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ SYMFONY_PATCH_TYPE_DECLARATIONS=force=phpdoc ./vendor/bin/patch-type-declarations</span></span></code></pre>
</div>

<p>After this minor release with all deprecations, you can safely add all
the missing return types in the next major version.</p>

<p>The downside of this process is that you cannot support Symfony 6 until
this major release of your own package. Make sure you keep on reading to
know how you can maybe even avoid this!</p>

<h2 id="we-need-you-to-make-everyones-life-better">We need YOU to make everyone’s life better</h2>

<p>As you can see in this post, adding return types can have quite an
impact on the community. Some return types might cause many packages to
release a new major version, potentially messing up any roadmaps or
other processes.</p>

<p>This is why we welcome you to report any return type deprecation that is
causing you to break compatibility in your package. You can do so in
<a href="https://github.com/symfony/symfony/issues/43021">this GitHub issue</a>.</p>

<p>We don’t promise anything, but based on the feedback we might postpone
some return types to Symfony 7 (to give you 2 more years to release a
new major version). We’ve already done so for some common methods found
in the Symfony bundles (e.g. <code class="highlighter-shiki">Command::execute(): int</code> and
<code class="highlighter-shiki">VoterInterface::vote(): int</code>).</p>

<h2 id="take-homes">Take Home’s</h2>

<ul>
  <li>Symfony 6 will be type safe</li>
  <li>There is a <a href="https://symfony.com/doc/5.4/setup/upgrade_major.html#upgrading-to-symfony-6-add-native-return-types"><code class="highlighter-shiki">patch-type-declarations</code> script</a> in Symfony 5.4+ that
automatically makes your code compatible</li>
  <li>Open source maintainers have 2.5 months to <a href="https://github.com/symfony/symfony/issues/43021">help us reduce the
impact</a> of this change</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="symfony" /><category term="pre-release" /><category term="contribute" /><summary type="html"><![CDATA[A very exciting time is coming with the biggest change for Symfony since Symfony 2.0: Symfony 6 has native PHP types on all its methods where it is possible. This will be a great push towards type safety in the PHP open source communities! Nicolas and Alexander have been working on and off for 2 years to create the best upgrade experience possible. Now, 2.5 months before the stable release, it is YOUR time to shine! Especially if you maintain any open source project (not even directly linked to Symfony), we would love to hear from you to make sure the upgrade isn’t dramatically hard.]]></summary></entry><entry><title type="html">Stabilizing Symfony: Testing out the pre-release</title><link href="https://wouterj.nl/2021/06/stabilizing-symfony-test-out-pre-releases" rel="alternate" type="text/html" title="Stabilizing Symfony: Testing out the pre-release" /><published>2021-06-17T00:00:00+00:00</published><updated>2021-06-17T00:00:00+00:00</updated><id>https://wouterj.nl/2021/06/stabilizing-symfony-test-out-pre-releases</id><content type="html" xml:base="https://wouterj.nl/2021/06/stabilizing-symfony-test-out-pre-releases"><![CDATA[<p>Symfony has a very rigid <a href="https://symfony.com/releases">release schedule</a> since Symfony 3.0.
Predictable releases are often mentioned as a major advantage. Did you
know that this schedule also includes a 2 month “stabilization phase”?
This phase gives time to all libraries and bundles to catch up. Testing
pre-releases is one of the best and least time consuming contributions
you can make to Symfony. Let’s see how you can help Symfony by reservering
30 minutes during these 2 months!</p>

<h2 id="a-quick-introduction-to-the-backwards-compatibility-promise">A quick Introduction to the Backwards Compatibility Promise</h2>

<p>It’s important to understand the <a href="https://symfony.com/bc">backwards compatibility promise</a>.
Projects used by many applications can’t simply change behavior of
features. Applications (and its developers) rely on stability of the
framework. In short, Symfony’s promise is that your application should
be able to upgrade from x.0 to x.4 <em>without any code changing efforts</em>.</p>

<aside class="side" data-type="BC Promise">
  <p>The <a href="https://symfony.com/bc">promise</a> does define some boundaries of the backwards
compatibility. For instance, if you use internal classes or an
experimental feature, there is a chance you need to make changes when
upgrading.</p>
</aside>

<p>Before releasing a new minor version (e.g. 5.3.0), the Symfony Core team
needs to make sure 2 conditions are true:</p>

<ul>
  <li>All changes to existing features are backwards compatible</li>
  <li>All new features must be stable.</li>
</ul>

<p>The last point is important: Once a feature lands in a stable release,
it’s no longer possible to change its behavior.</p>

<p>Now you know the main challenges Symfony is facing when releasing a new
minor version, let’s see how you can help!</p>

<h2 id="reporting-issues-during-stabilization">Reporting Issues during Stabilization</h2>

<p>New features are often tested in little demo applications. As we all
know, small demo applications often work much better than real life
applications. This is why bugs and backwards compatibility breaks
sometimes go completely unnoticed until real life applications start
upgrading.</p>

<p>Receiving feedback from real life applications is crucial: Symfony’s
only goal is to help you make real stuff in your daily jobs. It’s great
to receive bug reports, at all times. Yet, it’s significantly more
difficult to fix backwards compatibility breaks or bugs after a stable
release.</p>

<p>Imagine there is a backwards compatibility break (BC break) that
resulted in a PHP error. Applications that already upgraded fixed their
code to remove this error. This means that removing the BC break is also
a BC break in itself!</p>

<p>This is why testing pre-releases are critical. Pre-releases are not
covered by the BC promise. If you find a problem, we can fix the break
without yet another deprecation layer.</p>

<h2 id="how-to-test-pre-releases">How to Test Pre-Releases</h2>

<p>I hope by now, you understand the value of pre-release testing. But now,
how do you do this? Is it really just 30 minutes?</p>

<h3 id="testing-pre-releases-in-applications">Testing Pre-Releases in Applications</h3>

<p>Most people maintain Symfony applications: private projects using the
Symfony framework as a base. These projects can test pre-releases in 3
steps:</p>

<aside class="side" data-type="Quick note on stability flags">
  <p>During stabilization, Symfony releases a beta or RC (Release Candidate)
release almost on a weekly basis. Seeing the first beta release is great
indicator that Symfony has started with the stabilization phase.</p>

  <p>The RC releases are almost stable: They will probably no longer break
compatibility and the big issues are fixed.</p>

  <p>However, as bugs are continously fixed during the stabilization phase,
the dev branch is more stable than a pre-release made a couple days ago.
It’s often a great idea to use <code class="highlighter-shiki">@dev</code> instead of <code class="highlighter-shiki">@beta</code> or <code class="highlighter-shiki">@rc</code>.</p>
</aside>

<ol>
  <li>Update your <code class="highlighter-shiki">composer.json</code> to allow the next dev release. E.g.
change <code class="highlighter-shiki">5.3.*</code> to <code class="highlighter-shiki">5.4.*@dev</code> for all <code class="highlighter-shiki">symfony/*</code> packages to test
Symfony 5.4. 
Make sure to also update the <code class="highlighter-shiki">extra.symfony.require</code> key if it’s
present</li>
  <li>Add <code class="highlighter-shiki">&quot;minimum-stability&quot;: &quot;dev&quot;</code> and <code class="highlighter-shiki">&quot;prefer-stable&quot;: true</code> to your
<code class="highlighter-shiki">composer.json</code> file. This tells Composer to install dev versions,
but use stable versions for all your non-Symfony packages</li>
  <li>Update your dependencies and run your test suite</li>
</ol>

<p>Hopefully, your tests will pass. If they don’t, it means there is a BC
break or bug in the upcoming release.
In that case, you can <a href="https://symfony.com/doc/current/contributing/code/bugs.html">report a bug</a> to Symfony. It’s great
to also provide a reproducer: some code that allows everyone to
experience the bug you found. It’s hard to fix a bug if you don’t
experience it ;)</p>

<p>There is also a great benefit for you: You already tested your
application with the upcoming version. You may find yourself fixing some
deprecations on a boring Friday afternoon. Before you know it, your
applications is ready for the next release!</p>

<h3 id="testing-pre-releases-in-packages">Testing Pre-Releases in Packages</h3>

<p>Open source packages often test against multiple versions of their
dependencies (e.g. they test support for Symfony 4 and 5).</p>

<p>You can also add a “dev” version to test your package with the next
version of your dependencies. When running the dev tests, you can use
<code class="highlighter-shiki">composer config</code> to allow dev dependencies:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">composer config minimum-stability dev</span></span></code></pre>
</div>

<p>This means your package now also tests against the dev dependencies.
This is a great way to see if you support upcoming versions, as well as
discovering bugs in your dependencies early. Depending on the stability
of your dependencies, it can be a good idea to allow the dev tests to
fail (e.g. using <code class="highlighter-shiki">allow_failures</code> in Travis CI).</p>

<p>I’ve used this technique in my own packages, which you can use as an
example:</p>

<ul>
  <li><a href="https://github.com/wouterj/WouterJEloquentBundle/blob/2.x/.github/workflows/tests.yml#L68-L74">GitHub Actions</a></li>
  <li><a href="https://github.com/wouterj/WouterJEloquentBundle/blob/4284b3c56c1f04bc9faf31783e702d292afc455f/.travis.yml#L37-L40">Travis CI</a></li>
</ul>

<h2 id="take-homes">Take Homes</h2>

<ul>
  <li>Contributing to Symfony doesn’t only include writing code</li>
  <li>Bugs are much more easily fixed in a pre-release</li>
  <li>Please test pre-releases (of any software) and report issues you find</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="symfony" /><category term="contribute" /><category term="pre-release" /><summary type="html"><![CDATA[Symfony has a very rigid release schedule since Symfony 3.0. Predictable releases are often mentioned as a major advantage. Did you know that this schedule also includes a 2 month “stabilization phase”? This phase gives time to all libraries and bundles to catch up. Testing pre-releases is one of the best and least time consuming contributions you can make to Symfony. Let’s see how you can help Symfony by reservering 30 minutes during these 2 months!]]></summary></entry><entry><title type="html">Meet the new Symfony Security: Authenticators</title><link href="https://wouterj.nl/2020/04/authenticators-new-symfony-security" rel="alternate" type="text/html" title="Meet the new Symfony Security: Authenticators" /><published>2020-04-28T00:00:00+00:00</published><updated>2020-04-28T00:00:00+00:00</updated><id>https://wouterj.nl/2020/04/authenticators-new-symfony-security</id><content type="html" xml:base="https://wouterj.nl/2020/04/authenticators-new-symfony-security"><![CDATA[<p>After more than half a year of work and discussions, Symfony 5.1 ships
with an experimental and revisited Security system. I’m incredibly
excited about this system, as I think it opens up the component for a
lot of possibilities. That’s why in the coming week, I’ll publish a
series of blogposts about this new system. I hope you’ll be just as
excited as I am and help realising the full potential with us!</p>

<aside class="side" data-type="Try it yourself!">
  <p>If you’re using Symfony 5.1, the SecurityBundle comes with all tools you
need! Set <code class="highlighter-shiki">security.enable_authenticator_manager</code> to <code class="highlighter-shiki">true</code> to enable the
new system!</p>

  <p>Please be aware that this new system in experimental. It may contain
backwards compatibility breaks in 5.2. However, I don’t like to ruin the
life of early-testers so we keep this to the bare minimum. Please give it
a go and report any suggestions, problems, bugs, leaks or whatever!</p>
</aside>

<p>So… what is so different about this new system? It would like to
summarize it in three topics:</p>

<ul>
  <li><a href="#removed-everything-but-guards">It removes everything but Guard</a></li>
  <li><a href="#moved-to-an-event-based-system">It refactored to an event-based System</a></li>
  <li><a href="#the-next-generation-of-guards">It introduces the next generation of Guards</a></li>
</ul>

<h2 id="removed-everything-but-guards">Removed everything but Guards</h2>

<p>Since Symfony 2.0, the authentication system of Symfony can be drawn
like this:</p>

<p><img src="/img/security2-providers-listeners.png" alt="Symfony Security" /></p>

<p>This diagram has set-up 2 firewalls (yellow and red). The yellow
firewall has 2 different ways to authenticate (e.g. login form and json
login) and the red firewall has one way to authenticate (e.g. JWT).</p>

<p>A <em>firewall listener</em> extracts all necessary information from the
request (e.g. username, password, csrf token). This is passed into a
global <em>authentication manager</em>, which then calls the required
<em>authentication provider</em> (e.g. one that can authenticate a username and
password).</p>

<p>If you were to write your own custom authentication, you would most
likely need to provide a custom <em>listener</em>. This listener needs to do
all stuff: calling the manager, storing the authenticated token, setting
up the session (e.g. migrating it) and creating a correct response. It’s
very easy to forget a step, resulting in a less secure or broken
authentication. Hence, if you look at Symfony’s own firewall listeners,
you can find minor inconsistencies as well.</p>

<p>The new authenticator system can be drawn like this:</p>

<p><img src="/img/security2-authenticators.png" alt="Symfony Authenticators" /></p>

<ol>
  <li>There is <em>only one</em> listener, provided by Symfony, that passes the
request into an authenticator manager</li>
  <li>There is <em>one</em> authenticator manager per firewall. This manager calls
the correct authenticator, which authenticates the request and
returns a response</li>
</ol>

<p>You now only need to write a custom authenticator. The authenticator
manager (maintained by Symfony) takes care of session management,
storing the token, remember me functionality, etc. So there are less
things to forget!</p>

<p>This may appear to be similar to Guards in the current system… It is!
However, the internal logics of the component was still using the
listeners and providers. This new system makes them all use exactly the
same interface: Authenticators. This makes it easier to understand and
contribute to the Security component.</p>

<p>As there now is one authenticator manager per firewall, the manager
knows how to authenticate a request and return a success response. <strong>This
also allowed us to add programmatic login to Symfony</strong>: The manager is
now finally able to authenticate a User object and return a success
response.</p>

<h2 id="moved-to-an-event-based-system">Moved to an Event-based System</h2>

<p>Symfony’s HttpKernel component is built around
<a href="https://symfony.com/doc/current/components/http_kernel.html#httpkernel-driven-by-events">5 kernel events</a>.
Listeners to these events execute the core process of Symfony: finding a
controller, executing that controller and handling the response. You can
also create your own event listeners on these events, so you can
completely customize and extend this core process.</p>

<aside class="side" data-type="Here's how you can help">
  <p>I can imagine Symfony providing a <em>login throttling listener</em>, which
blocks login for a couple of minutes after too many failed attempts.</p>

  <p>Or e.g. a monolog logger to log failed attempts (such that you can
analyse them and block misbehaving IPs or the like).</p>

  <p>You can probably come up with even better ideas of listeners! Please
contribute them to Symfony.</p>
</aside>

<p>Up to now, the Security component didn’t use events for this purpose.
This made many parts of the component quite hard to extend or customize.
That’s why this new system is built around 3 main events:</p>

<dl>
  <dt><code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code></dt>
  <dd>This is the most important event. Its listeners validate any
credentials returned from the authenticator (e.g. a password or CSRF
token).</dd>
  <dt><code class="highlighter-shiki">LoginSuccessEvent</code></dt>
  <dd>If all credentials were valid, this event is dispatched. The core
system uses this to e.g. create a remember me cookie or upgrade the
password hash.</dd>
  <dt><code class="highlighter-shiki">LoginFailureEvent</code></dt>
  <dd>If there was an error or credentials are not correct, this event is
dispatched.</dd>
</dl>

<p>All core logic is now executed as listener on these events. E.g. if an
authenticator requires a password to be validated, a listener on
<code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code> will do this for you. Things like
user checkers, session strategies, remember me cookies, password
upgrading are all done inside event listeners.</p>

<h2 id="the-next-generation-of-guards">The Next Generation of Guards</h2>

<aside class="side" data-type="Here's how you can help">
  <p>It would be lovely to have many more modern authenticators inside
Symfony core:</p>

  <ul>
    <li>Third-party/redirections: SAML, OAuth, …</li>
    <li>API tokens: JWT, JOSE, PASETO, Windows Identity Foundation, …</li>
    <li>“Magic links” sent via Notifier component</li>
  </ul>
</aside>

<p>A few years ago,
<a href="https://symfonycasts.com/blog/guard-authentication">Guards</a> where
introduced to provide a better extension point for Security. The new
system started with this exact Guard interface as a base. The event
based logic introduced a centralized credentials checking. This removed
the need for a <code class="highlighter-shiki">checkCredentials()</code> method in the Guard interface. Later
on, we introduced some more changes to the interface: The next generation
<code class="highlighter-shiki">AuthenticatorInterface</code> was born!</p>

<p>The big change from the Guard interface you may know is that
<code class="highlighter-shiki">getCredentials()</code> and <code class="highlighter-shiki">getUser()</code> are merged into one method:
<code class="highlighter-shiki">authenticate(Request $request)</code>. And, as mentioned before,
<code class="highlighter-shiki">checkCredentials()</code> is gone.</p>

<p>This new <code class="highlighter-shiki">authenticate()</code> method creates a <em>Security Passport</em>. This is
a new concept in authenticators. <strong>A passport contains the user and any
credentials needed to authenticate.</strong> This extra information is provided
using <em>Passport Badges</em>. Listeners on the
<code class="highlighter-shiki">VerifyAuthenticatorCredentialsEvent</code> will validate and check the
passport and all its badges. If <em>all</em> badges are resolved, the user is
succesfully authenticated.</p>

<p>Let’s see the passport in action. Assume we’re building a form login:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">HttpFoundation</span><span style="color: #999999">\</span><span style="color: #C7C8D2">Request</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Exception</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UsernameNotFoundException</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AuthenticatorInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Badge</span><span style="color: #999999">\</span><span style="color: #C7C8D2">CsrfTokenBadge</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Credentials</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PasswordCredentials</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #C7C8D2">Passport</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="8"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Http</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authenticator</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Passport</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PassportInterface</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="9"></span>
<span class="line" data-linenr="10"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">FormAuthenticator</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AuthenticatorInterface</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="12"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="13"></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">authenticate</span><span style="color: #999999">(</span><span style="color: #C7C8D2">Request</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #999999">)</span><span style="color: #E5673D">:</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PassportInterface</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="16"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// find a user based on an &quot;email&quot; form field</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">userRepository</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">findOneByEmail</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">email</span><span style="color: #999999">&#39;</span><span style="color: #999999">))</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">!$</span><span style="color: #D8DEE9">user</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="19"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">throw</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UsernameNotFoundException</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="21"></span>
<span class="line" data-linenr="22"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// return the Security passport</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Passport</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// add the user we&#39;ve just found</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="26"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// add credentials from the &quot;password&quot; form field</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PasswordCredentials</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #999999">)),</span></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">            </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="29"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic">// and CSRF protection using a &quot;csrf_token&quot; field</span></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">CsrfTokenBadge</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">loginform</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">csrf_token</span><span style="color: #999999">&#39;</span><span style="color: #999999">))</span></span>
<span class="line" data-linenr="31"></span>
<span class="line" data-linenr="32"><span style="color: #999999">                </span><span style="color: #6B90C0; font-style: italic">// and add support for upgrading the password hash</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PasswordUpgradeBadge</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="34"><span style="color: #BBBBBB">                    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">request</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">get</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">                    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">userRepository</span></span>
<span class="line" data-linenr="36"><span style="color: #BBBBBB">                </span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">            </span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="38"><span style="color: #BBBBBB">        </span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="39"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="40"><span style="color: #999999">}</span></span></code></pre>
</div>

<aside class="side" data-type="Here's how you can help">
  <p>I’ve talked before on <a href="/2019/03/security-removing-user">removing the User object from Security</a>.
The main passport interface does not require a user. I invite anyone to
build a system that works without user and submit it to Symfony.</p>
</aside>

<p>This gives an authenticator all power about what is needed for
successful authentication. At the same time, the most important piece is
handled centralized in an event listener. This makes applications less
vunerable, as security leaks will be fixed by the Symfony Security
team. You can also write your own listener to resolve a badge before a
listener of Symfony, to customize the checks.</p>

<p>There also is a <code class="highlighter-shiki">CustomCredentials</code> class that you can use to call a
custom method to check credentials and a <code class="highlighter-shiki">SelfCheckingPassport</code> in case
you don’t need Symfony to check any credentials (e.g. when using API tokens).</p>

<h2 id="next-up">Next up</h2>

<p>I plan to write at least two more blogposts about the new system in the
coming weeks. We’ll write real code for a real custom logins on both of these:</p>

<ul>
  <li>Writing a custom authenticator: Passwords &amp; Badges</li>
  <li>Customizing security using event listeners</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="symfony" /><category term="security" /><summary type="html"><![CDATA[After more than half a year of work and discussions, Symfony 5.1 ships with an experimental and revisited Security system. I’m incredibly excited about this system, as I think it opens up the component for a lot of possibilities. That’s why in the coming week, I’ll publish a series of blogposts about this new system. I hope you’ll be just as excited as I am and help realising the full potential with us!]]></summary></entry><entry><title type="html">Learn to Write more Concise</title><link href="https://wouterj.nl/2020/02/learn-to-write-more-concise" rel="alternate" type="text/html" title="Learn to Write more Concise" /><published>2020-02-10T00:00:00+00:00</published><updated>2020-02-10T00:00:00+00:00</updated><id>https://wouterj.nl/2020/02/learn-to-write-more-concise</id><content type="html" xml:base="https://wouterj.nl/2020/02/learn-to-write-more-concise"><![CDATA[<p>Ernest Hemingway is a writer from the twentieth-century know for his
short and declarative writing style. Hemingwayapp.com is a free online
tool that analyses your text according to this style. It also runs the
Automated Readability Index algorithm. This makes it a perfect tool to
write concise, short and easy to understand texts.</p>

<article class="external">
  <p><img src="/img/hemingway-app-screenshot.png" class="external__hero" /></p>

  <h3 class="external__target"><a href="http://www.hemingwayapp.com/">http://www.hemingwayapp.com</a></h3>

  <p class="external__description">Hemingway makes your writing bold and clear. It’s like a
  spellchecker, but for style. It makes sure that your reader will focus
  on your message, not your prose.

  Too often, our words are like our thoughts — innumerable and
  disorganized. Almost any bit of writing could use some cutting. Less
  is more, etc.</p>
</article>

<p>I almost always copy-paste my writings into the tool to check and
revisit some redundant parts and too long sentences. An average adult
reads around the 10th grade. All development language often doesn’t have
a good influence on your grade, but at least you are aware of the
difficulty of your text.</p>]]></content><author><name>Wouter de Jong</name></author><category term="link" /><category term="symfony" /><category term="security" /><summary type="html"><![CDATA[Ernest Hemingway is a writer from the twentieth-century know for his short and declarative writing style. Hemingwayapp.com is a free online tool that analyses your text according to this style. It also runs the Automated Readability Index algorithm. This makes it a perfect tool to write concise, short and easy to understand texts.]]></summary></entry><entry><title type="html">Grant on Permissions, not Roles</title><link href="https://wouterj.nl/2020/01/grant-on-permissions-not-roles" rel="alternate" type="text/html" title="Grant on Permissions, not Roles" /><published>2020-01-14T00:00:00+00:00</published><updated>2020-01-14T00:00:00+00:00</updated><id>https://wouterj.nl/2020/01/grant-on-permissions-not-roles</id><content type="html" xml:base="https://wouterj.nl/2020/01/grant-on-permissions-not-roles"><![CDATA[<p>Symfony uses a very flexible voter approach to grant access for a user.
As this is often based on domain-specific requirements and decisions,
the voters that come with Symfony are very basic. I would even argue
that it’s better if you not use them, and only rely on custom security
voters.</p>

<h2 id="terminology">Terminology</h2>

<p>In Symfony security, the string <code class="highlighter-shiki">ROLE_USER</code> can actually mean a lot of
things, let’s first establish a common meaning:</p>

<p>What you pass into <code class="highlighter-shiki">isGranted()</code> calls is a <em>security attribute</em>. It
<em>can</em> start with <code class="highlighter-shiki">ROLE_</code>, but any other text is possible as well.</p>

<p>A user has <em>security roles</em>. These are returned by <code class="highlighter-shiki">UserInterface#getRoles()</code>
and always start with <code class="highlighter-shiki">ROLE_</code>.</p>

<p>The <code class="highlighter-shiki">roles</code> setting in your access control is passed into
<code class="highlighter-shiki">AccessDecisionManager#decide()</code> (which is also what <code class="highlighter-shiki">isGranted()</code>
uses). While the setting is named “roles”, this is actually a
<em>security attribute</em>.</p>

<h2 id="meet-the-role-voters">Meet the Role Voters</h2>

<aside class="side" data-type="Vote strategy">
  <p>By default, Symfony’s election is “affirmative”. This means that if one voter
votes for GRANT, the user is granted. This strategy can be changed using
<a href=""><code class="highlighter-shiki">security.access_control_manager.strategy</code></a>.</p>
</aside>

<p>If you call <code class="highlighter-shiki">isGranted()</code> in some way, a small election organized by Symfony
Security takes place. Each voter votes GRANT, DENY or ABSTAIN. Voters
vote for a specific <em>security attribute</em>, with some optional context
(the 2nd argument of <code class="highlighter-shiki">isGranted()</code>).</p>

<p>Voters are powerful, but, as said in the intro, often depent on lots of
business logic. This is why Symfony cannot provide many voters. To make
the security system work, it comes with two very primitive voters:
<code class="highlighter-shiki">RoleVoter</code> and <code class="highlighter-shiki">RoleHierarchyVoter</code>.</p>

<p>These voters activate as soon as the <em>security attribute</em> starts with
<code class="highlighter-shiki">ROLE_</code> (e.g. <code class="highlighter-shiki">isGranted(&#39;ROLE_USER&#39;)</code> or <code class="highlighter-shiki">isGranted(&#39;ROLE_ADMIN&#39;)</code>).
They check if the current user has this role (or if the
<a href="https://symfony.com/doc/current/security.html#security-role-hierarchy">role hierarchy</a> contains this role).</p>

<h2 id="whats-wrong-with-voting-based-on-roles">What’s wrong With Voting based on Roles?</h2>

<p>Voting on a role is very easy: It’s supported by default and gets the job done.
Yet, it doesn’t add any flexibility. Also, complex cases result in a
lots of code in a controller and often code duplication.</p>

<p><strong>Roles belong to authentication (identification), rather than
authorization.</strong></p>

<p><img src="/img/security-roles-as-identification.png" alt="roles groups users" /></p>

<p>Roles defines the role (or function/task) of this user on the website.
Someone might be the “moderator” on this forum, just a regular visitor or
some premium plan member. That’s their role. <em>Roles allows your
application to group different users together. This makes granting
permissions easier.</em> For instance, it’s difficult to describe that users
John, Mary and William are allowed to edit all posts. It’s easier to
group them as being “the moderators” of this website. You can then grant
the permissions “edit all posts” to the “moderators” role.</p>

<p>So rather than using roles as permissions, you relate permissions to
specific roles. These permissions are then voted on by a custom voter.
This allows you to change permissions throughout your code base easier
and keep your controllers thin.</p>

<h2 id="grant-access-for-permissions">Grant Access for Permissions</h2>

<p>For this example, let’s create a voter for a blog post. We want to end
up with a call like <code class="highlighter-shiki">isGranted(&quot;POST_EDIT&quot;, $blogPost)</code>. The voter
should then decide if the current user is allowed to edit the blog post.
They should be allowed if any of these is true:</p>

<ul>
  <li>If it’s a <em>user</em>, it should be the author of the post</li>
  <li>If it’s a <em>moderator</em>, it should always be allowed</li>
  <li>If it’s a <em>senior user</em>, it should be senior for that specific topic</li>
</ul>

<p>Do you see how we now relate the <em>role of the user</em> to the <em>specific
permission of editing a blog post</em>?</p>

<h2 id="creating-the-voter">Creating the Voter</h2>

<aside class="side" data-type="Without MakerBundle">
  <p>If you don’t have the maker bundle, either install it or create a PHP
class that extends the <code class="highlighter-shiki">Voter</code> class.</p>
</aside>

<p>So the solution is to create your own voter. It’s a PHP class
implementing Symfony’s <code class="highlighter-shiki">VoterInterface</code>. For easy usage, there is an
abstract class named <code class="highlighter-shiki">Voter</code>. If you have the <a href="">MakerBundle</a> installed,
you’re lucky:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ bin/console make:voter</span></span></code></pre>
</div>

<h3 id="specify-if-the-voter-supports-this-call">Specify if the Voter Supports this Call</h3>

<p>The <code class="highlighter-shiki">Voter#supports()</code> returns a boolean, depending on whether it wants
to join the election for this <em>security attribute</em> and <em>context</em>. In
this example, the security attribute should be <code class="highlighter-shiki">POST_EDIT</code> and the
entity should be instance of <code class="highlighter-shiki">BlogPost</code>:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">BlogPostVoter</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Voter</span></span>
<span class="line" data-linenr="3"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">protected</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">supports</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attribute</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">subject</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="5"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">POST_EDIT</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">===</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attribute</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">&amp;&amp;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">subject</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">instanceof</span><span style="color: #BBBBBB"> </span><span style="color: #999999">\</span><span style="color: #BBBBBB">App</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Entity</span><span style="color: #999999">\</span><span style="color: #C7C8D2">BlogPost</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="9"></span>
<span class="line" data-linenr="10"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="11"><span style="color: #999999">}</span></span></code></pre>
</div>

<h3 id="write-the-decision-logic">Write the Decision Logic</h3>

<p>If the voter indicated that it supported this call,
<code class="highlighter-shiki">Voter#voteOnAttribute()</code> is called. This method implements the
permission logic:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">BlogPostVoter</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">extends</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">Voter</span></span>
<span class="line" data-linenr="3"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">private</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">public</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">__construct</span><span style="color: #999999">(</span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="12"></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #6B90C0; font-style: italic">/**</span></span>
<span class="line" data-linenr="14"><span style="color: #6B90C0; font-style: italic">     * @param </span><span style="color: #C7C8D2; font-style: italic">BlogPost</span><span style="color: #6B90C0; font-style: italic"> $blogPost</span></span>
<span class="line" data-linenr="15"><span style="color: #6B90C0; font-style: italic">     */</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">protected</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">voteOnAttribute</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attribute</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">blogPost</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">TokenInterface</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="17"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="18"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getUser</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="19"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// if the user is anonymous, do not grant access</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">!$</span><span style="color: #D8DEE9">user</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">instanceof</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserInterface</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">false;</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="23"></span>
<span class="line" data-linenr="24"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// if the user is a moderator, always allow</span></span>
<span class="line" data-linenr="25"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">ROLE_MODERATOR</span><span style="color: #999999">&#39;</span><span style="color: #999999">]))</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true;</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="28"></span>
<span class="line" data-linenr="29"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Allow if the user is senior on this topic</span></span>
<span class="line" data-linenr="30"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">isSeniorIn</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">blogPost</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getTopic</span><span style="color: #999999">())</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true;</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="33"></span>
<span class="line" data-linenr="34"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Allow if the user wrote this post</span></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">blogPost</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getAuthor</span><span style="color: #999999">()</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">===</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">user</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="36"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true;</span></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="38"></span>
<span class="line" data-linenr="39"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// Otherwise, deny access</span></span>
<span class="line" data-linenr="40"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">false;</span></span>
<span class="line" data-linenr="41"><span style="color: #BBBBBB">    }</span></span>
<span class="line" data-linenr="42"><span style="color: #BBBBBB">}</span></span></code></pre>
</div>

<p>As you see, in the voter we do call <code class="highlighter-shiki">decide()</code> with a role. But that’s
fine, this class is meant to relate permissions (<code class="highlighter-shiki">POST_EDIT</code>) to a
user’s role on the website.</p>

<p>We can now use <code class="highlighter-shiki">isGranted(&#39;POST_EDIT&#39;, $blogPost)</code> in our application to
check if the user is allowed to edit the blog post. The access decision
manager will call our custom voter to decide on this. If we ever need
more complex logic to check, we only have to update the code in the
voter.</p>

<p>It’s often a good idea to create one voter per entity. This voter can be
extended to also vote on <code class="highlighter-shiki">POST_CREATE</code>, <code class="highlighter-shiki">POST_DELETE</code>, etc. To check if
a Create button should be shown, I recommend passing the FQCN as context
as there is no object yet (e.g.
<code class="highlighter-shiki">is_granted(&#39;POST_CREATE&#39;, &#39;App\Entity\BlogPost&#39;)</code>).</p>

<h2 id="make-your-voters-dynamic-access-logic-in-the-database">Make your Voters Dynamic (Access Logic in the Database)</h2>

<p>Instead of hardcoding all your permissions in the voters, you can also
read information from the database inside your voter. This allows you to
persist permissions in the database, which can then be managed by users
in an admin panel or the like.</p>

<aside class="side" data-type="Caution">
  <p>This example is just to illustrate the flexibility of the Voter
principle. It isn’t necessarily battle-tested or recommended for
production usage.</p>
</aside>

<p>In the most generic way, you can create a <code class="highlighter-shiki">Permission</code> entity that
specifies which roles are required for a specific security attribute. It
may also use Symfony’s <a href="https://symfony.com/doc/current/security/expressions.html">ExpressionLanguage component</a>) to
check additional conditions:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">class</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PermissionVoter</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">implements</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">VoterInterface</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">{</span></span>
<span class="line" data-linenr="3"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// this vote() method is the only required method of VoterInterface</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// it should return ACCESS_ABSTAIN (i.e. not supported),</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ACCESS_GRANTED or ACCESS_DENIED.</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">protected</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">function</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">vote</span><span style="color: #999999">(</span><span style="color: #C7C8D2">TokenInterface</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">subject</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">array</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attributes</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attribute</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attributes</span><span style="color: #999999">[</span><span style="color: #B48EAD">0</span><span style="color: #999999">]</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// find all stored permissions for this attribute and subject</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permissions</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">permissionRepository</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">findBy</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">            </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">attribute</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">attribute</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">            </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">subject</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">subject</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">        </span><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="17"></span>
<span class="line" data-linenr="18"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// do not deny/grant if there is no permission for this</span></span>
<span class="line" data-linenr="19"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// attribute and subject</span></span>
<span class="line" data-linenr="20"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #B48EAD">0</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">===</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">count</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permissions</span><span style="color: #999999">))</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">self::</span><span style="color: #BBBBBB">ACCESS_ABSTAIN</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="23"></span>
<span class="line" data-linenr="24"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">foreach</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permissions</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">as</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permission</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="25"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// continue if the role of the user does not match the role</span></span>
<span class="line" data-linenr="26"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// of this permission</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">!$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permission</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getRole</span><span style="color: #999999">()]))</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="28"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">continue;</span></span>
<span class="line" data-linenr="29"><span style="color: #BBBBBB">            </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="30"></span>
<span class="line" data-linenr="31"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// if the permission has an extra expression, verify this is</span></span>
<span class="line" data-linenr="32"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic">// true, otherwise grant access directly</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">expr</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">permission</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getExpression</span><span style="color: #999999">()</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="34"><span style="color: #BBBBBB">            </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">expr</span><span style="color: #999999">)</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="35"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">if</span><span style="color: #BBBBBB"> </span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">this</span><span style="color: #E5673D">-&gt;</span><span style="color: #D8DEE9">decisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">expr</span><span style="color: #999999">]))</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="36"><span style="color: #BBBBBB">                    </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">self::</span><span style="color: #BBBBBB">ACCESS_GRANTED</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="37"><span style="color: #BBBBBB">                </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="38"><span style="color: #BBBBBB">            </span><span style="color: #999999">}</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">else</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span></span>
<span class="line" data-linenr="39"><span style="color: #BBBBBB">                </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">self::</span><span style="color: #BBBBBB">ACCESS_GRANTED</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="40"><span style="color: #BBBBBB">            </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="41"><span style="color: #BBBBBB">        </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="42"></span>
<span class="line" data-linenr="43"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic">// in any other case, deny access</span></span>
<span class="line" data-linenr="44"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">return</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">self::</span><span style="color: #BBBBBB">ACCESS_DENIED</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="45"><span style="color: #BBBBBB">    </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="46"><span style="color: #999999">}</span></span></code></pre>
</div>

<h2 id="take-homes">Take Home’s</h2>

<ul>
  <li>Roles are identification: They allow your application to group
similar types of users</li>
  <li>Voters relate roles to specific permissions</li>
  <li>Avoid granting access based on roles in your application, consider
writing a custom voter for them</li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="symfony" /><category term="security" /><summary type="html"><![CDATA[Symfony uses a very flexible voter approach to grant access for a user. As this is often based on domain-specific requirements and decisions, the voters that come with Symfony are very basic. I would even argue that it’s better if you not use them, and only rely on custom security voters.]]></summary></entry><entry><title type="html">Understanding Symfony Security by Using it Standalone</title><link href="https://wouterj.nl/2019/03/understanding-symfony-security-by-using-it-standalone" rel="alternate" type="text/html" title="Understanding Symfony Security by Using it Standalone" /><published>2019-03-20T00:00:00+00:00</published><updated>2019-03-20T00:00:00+00:00</updated><id>https://wouterj.nl/2019/03/understanding-symfony-security-by-using-it-standalone</id><content type="html" xml:base="https://wouterj.nl/2019/03/understanding-symfony-security-by-using-it-standalone"><![CDATA[<p>Setting up big Symfony components in a blank PHP project helps a lot to
understand it. You’ll grasp the main architecture of the component much easier
this way. Let’s try to understand Symfony Security by doing exactly this!</p>

<h2 id="security-101">Security 101</h2>

<p>On almost all platforms, security consists of two phases: Authentication and
Authorization. Let’s quickly discuss them before digging deep into Symfony
security:</p>

<p><img src="/img/security-phases.png" alt="Authentication and Authorization" /></p>

<ol>
  <li><strong>Who are you?</strong> is the main question of <em>Authentication</em>. Every HTTP request
again, we have to find out who the requester is. At first visit to a site,
this is usually a login form. A second request often uses a session stored
after logging in to find out who you are. An API call often uses API tokens</li>
  <li><strong>Are you allowed to do this?</strong> is the question answered during
<em>Authorization</em>. Every request involves an action. For instance, you are
reading this blog article, I’m editing it at the moment, over 10 years I’ll
probably delete it, etc. During authorization, we find out if the person
identified in (1) is allowed to do the action he wants to do</li>
</ol>

<h2 id="set-up-our-blank-project">Set-up our Blank Project</h2>

<aside class="side" data-type="example">
  <p>The final project of this blogpost can be found at
<a href="https://github.com/wouterj-nl/security-standalone">github</a>.</p>
</aside>

<p>Setting up a blank project is nothing more than creating a new directory. In
the directory, we’ll use <a href="https://getcomposer.org/">Composer</a> to install the
Security Core component:</p>

<div class="language-bash highlighter-shiki"><pre class="shiki-gutter">1
2
3
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #BBBBBB">$ mkdir security-101</span></span>
<span class="line" data-linenr="2"><span style="color: #BBBBBB">$ </span><span style="color: #C7C8D2">cd</span><span style="color: #BBBBBB"> security-101</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">$ composer require symfony/security-core</span></span></code></pre>
</div>

<p>Security contains a couple sub components: Core, Http, Guard, Csrf. In this
post, we’ll focus on the core only. In a funny plot twist, you’ll directly
discover what HTTP is doing if you’re reading the side notes!</p>

<h2 id="authentication-input-the-token">Authentication Input: The token</h2>

<p>The question “who are you?” can only be answered if we have input from the user
world (there must be a “you”). This input can be anything. As already
explained, the values of the login form upon login is one example of this
input. In all requests after the user logged in, a browser session represents
the input from user world.</p>

<aside class="side" data-type="Symfony internals">
  <p>The HTTP Security component uses listeners attached to
<a href="https://symfony.com/doc/current/reference/events.html#kernel-request"><code class="highlighter-shiki">kernel.request</code></a>
to create tokens. For instance, the
<a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/UsernamePasswordFormAuthenticationListener.php"><code class="highlighter-shiki">UsernamePasswordFormAuthenticationListener</code></a>
creates a <code class="highlighter-shiki">UsernamePasswordToken</code> based on the login form submit.</p>
</aside>

<p>As our goal is just to write one working PHP file, we’ll use static strings as
“input from the user”:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #E5673D">&lt;?</span><span style="color: #BBBBBB">php </span><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">require_once</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">vendor/autoload.php</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Token</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UsernamePasswordToken</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">token</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UsernamePasswordToken</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">default</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>This type of token is most often used in traditional applications, it holds a
username and a password (ignore that third argument for the moment). Other
tokens are for instance a <code class="highlighter-shiki">RememberMeToken</code>, which uses a browser cookie, or
you can create an <code class="highlighter-shiki">BearerToken</code> that contains a header used for API requests.</p>

<h3 id="lets-authenticate-the-token-meet-the-authenticationmanager">Let’s Authenticate the Token: Meet the AuthenticationManager</h3>

<p>Now we have the token representing the user input, it’s time to authenticate
it. The Security component provides an <code class="highlighter-shiki">AuthenticationManagerInterface</code> for this.
By default, only one implementation of this interface is provided: The
<code class="highlighter-shiki">AuthenticationProviderManager</code>. Its name is quite confusing, it’s not managing
<em>authentication providers</em>, but it is the <em>authentication manager</em> based on
<em>authentication providers</em>.</p>

<p><code class="highlighter-shiki">AuthenticationProviderInterface</code> classes do the hard work for this manager:
They transform an unauthenticated token into an authenticated token. In other
words, they transform user input into a security identity.</p>

<aside class="side" data-type="Symfony internals">
  <p><a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/Authentication/Provider">Other authentication providers</a>
are for instance a <code class="highlighter-shiki">RememberMeAuthenticationProvider</code> (authenticating a remember-me
cookie) and an <code class="highlighter-shiki">AnonymousAuthenticationProvider</code> (which always returns a token
representing an anonymous user).</p>
</aside>

<p>The most commonly used provider is the <code class="highlighter-shiki">DaoAuthenticationProvider</code> (<strong>D</strong>ata
<strong>A</strong>ccess <strong>O</strong>bject). It uses a <em>user provider</em> to find a user matching the
input from somewhere and then matches the password (using a <em>password encoder</em>).</p>

<h3 id="set-up-some-user-resources-the-userprovider">Set-up some User Resources: The UserProvider</h3>

<p>To get things working, we first define a class able to load users from “some
resource”. In this case, we use the <code class="highlighter-shiki">InMemoryUserProvider</code> that fetches users
from a PHP array.</p>

<aside class="side" data-type="Symfony internals">
  <p><a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/User">Other user providers</a>
load users from a database or LDAP servers.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">InMemoryUserProvider</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">InMemoryUserProvider</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">    </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span></span>
<span class="line" data-linenr="7"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">password</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">roles</span><span style="color: #999999">&#39;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_SUPERVISOR</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #999999">],</span></span>
<span class="line" data-linenr="10"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// As an example of this class, let&#39;s find the user:</span></span>
<span class="line" data-linenr="13"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">wouterUser</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">loadUserByUsername</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">wouter</span><span style="color: #999999">&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<h3 id="safety-first-encrypted-user-passwords">Safety first: Encrypted User Passwords</h3>

<p>Saving plain texts passwords is a no-go for web applications. They are often
encoded using for instance bcrypt or sha256. This is abstracted in <em>password
encoders</em>. They are able to encode a plain text password and check whether the
password entered by the user was valid:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Encoder</span><span style="color: #999999">\</span><span style="color: #C7C8D2">EncoderFactory</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Encoder</span><span style="color: #999999">\</span><span style="color: #C7C8D2">PlaintextPasswordEncoder</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">EncoderFactory</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// we take the easiest road: plain text passwords</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">::class</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=&gt;</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">PlaintextPasswordEncoder</span><span style="color: #999999">(),</span></span>
<span class="line" data-linenr="10"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// First, get the encoder associated with our user (other users</span></span>
<span class="line" data-linenr="13"><span style="color: #6B90C0; font-style: italic">// can use other encoders).</span></span>
<span class="line" data-linenr="14"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getEncoder</span><span style="color: #999999">(</span><span style="color: #C7C8D2">User</span><span style="color: #E5673D">::class</span><span style="color: #999999">)</span></span>
<span class="line" data-linenr="15"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// Then, check whether some input matches our user&#39;s password:</span></span>
<span class="line" data-linenr="16"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">isPasswordValid</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">wouterUser</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getPassword</span><span style="color: #999999">(),</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">pa$$word</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;&#39;</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<h3 id="instantiating-the-authentication-manager">Instantiating the Authentication Manager</h3>

<p>Yay, it took quite some effort, but we’re ready to create the
<code class="highlighter-shiki">AuthenticationProviderManager</code>!</p>

<aside class="side" data-type="Symfony internals">
  <p>If you look closely, the <code class="highlighter-shiki">&#39;default&#39;</code> string is equal to the one provided in the
token: This is the <em>provider key</em>. It is used to make sure the token is from
our application and also to know which provided should handle the token
(multiple providers might be able to handle a <code class="highlighter-shiki">UsernamePasswordToken</code>).</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AuthenticationProviderManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authentication</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Provider</span><span style="color: #999999">\</span><span style="color: #C7C8D2">DaoAuthenticationProvider</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="4"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">User</span><span style="color: #999999">\</span><span style="color: #C7C8D2">UserChecker</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="5"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticationManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AuthenticationProviderManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">DaoAuthenticationProvider</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">userProvider</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">UserChecker</span><span style="color: #999999">(),</span></span>
<span class="line" data-linenr="11"><span style="color: #BBBBBB">        </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">default</span><span style="color: #999999">&#39;</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="12"><span style="color: #BBBBBB">        </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">encoderFactory</span></span>
<span class="line" data-linenr="13"><span style="color: #BBBBBB">    </span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="14"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>As you see, there is one more class: The <code class="highlighter-shiki">UserChecker</code>. It checks some “user
flags” after it is fetched from the user provider. This includes for instance
whether the user is activated, banned, etc.</p>

<h3 id="authenticating-the-token">Authenticating the Token</h3>

<aside class="side" data-type="Symfony internals">
  <p>The firewall listeners of Http security also call the authenticate method
directly. See for instance the
<a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/UsernamePasswordFormAuthenticationListener.php#L100"><code class="highlighter-shiki">UsernamePasswordFormAuthenticationListener</code></a>.</p>
</aside>

<p>Finally – we’re more than halfway the post now – we are able to authenticate
the token we created:</p>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticationManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">authenticate</span><span style="color: #999999">(</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">inputToken</span><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="6"></span>
<span class="line" data-linenr="7"><span style="color: #E5673D">echo</span><span style="color: #BBBBBB"> </span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">Hello </span><span style="color: #999999">&#39;</span><span style="color: #E5673D">.</span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getUsername</span><span style="color: #999999">()</span><span style="color: #E5673D">.</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">!</span><span style="color: #999999">&#39;</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<h2 id="authorize-actions-the-accessdecisionmanager">Authorize Actions: The AccessDecisionManager</h2>

<aside class="side" data-type="Symfony internals">
  <p>Symfony security started as a direct port of JAVA’s <a href="https://spring.io/projects/spring-security">Spring
Security</a>. This is why the naming
is often quite different from the rest of Symfony. It however, gives you two
documentations to understand Security!</p>
</aside>

<p>Now we’ve authenticated the user input and the Security system validated our
input, it’s time to answer the <em>Are you allowe to do this?</em> question. Let me
introduce you to yet another “manager”: <code class="highlighter-shiki">AccessDecisionManagerInterface</code>.</p>

<p>The default implementation uses “Security voters” to decide whether the user is
allowed to execute an action. These voters are provided with an <em>attribute</em>
(representing the action) and optionally some context (i.e. the subject of the
action).</p>

<aside class="side" data-type="Symfony internals">
  <p>In the Http component, an <a href="https://github.com/symfony/security/blob/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Http/Firewall/AccessListener.php"><code class="highlighter-shiki">AccessListener</code></a>
checks access using this manager based on the configured <code class="highlighter-shiki">access_control</code>
rules.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authorization</span><span style="color: #999999">\</span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// ... voters</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<p>The default voters of Symfony are a bit strange, they don’t validate an action,
but validate the user’s identity. One of them is the <code class="highlighter-shiki">RoleVoter</code>. It checks
whether <code class="highlighter-shiki">User#getRoles()</code> contains the provided attribute:</p>

<aside class="side" data-type="Symfony internals">
  <p>A <code class="highlighter-shiki">RoleHierarchyVoter</code> is also provided, which understands hierarchies in
roles (i.e. “admin is a user”). <a href="https://github.com/symfony/security/tree/88588499b5c3ed78becea8e0c4ec8d81e0e4f483/Core/Authorization/Voter">Another default voter</a>
is the <code class="highlighter-shiki">AuthenticatedVoter</code>, which checks if the token is fully authenticated,
anonymous, etc.</p>
</aside>

<div class="language-php highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #6B90C0; font-style: italic">// secure.php</span></span>
<span class="line" data-linenr="2"><span style="color: #E5673D">use</span><span style="color: #BBBBBB"> Symfony</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Component</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Security</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Core</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Authorization</span><span style="color: #999999">\</span><span style="color: #BBBBBB">Voter</span><span style="color: #999999">\</span><span style="color: #C7C8D2">RoleVoter</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="3"><span style="color: #6B90C0; font-style: italic">// ...</span></span>
<span class="line" data-linenr="4"></span>
<span class="line" data-linenr="5"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">AccessDecisionManager</span><span style="color: #999999">([</span></span>
<span class="line" data-linenr="6"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// TITLE_ is the prefix an attribute must have in order to be</span></span>
<span class="line" data-linenr="7"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic">// managed by this voter</span></span>
<span class="line" data-linenr="8"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">new</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">RoleVoter</span><span style="color: #999999">(</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_</span><span style="color: #999999">&#39;</span><span style="color: #999999">),</span></span>
<span class="line" data-linenr="9"><span style="color: #999999">])</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="10"></span>
<span class="line" data-linenr="11"><span style="color: #6B90C0; font-style: italic">// now we can use the access decision manager to see if the</span></span>
<span class="line" data-linenr="12"><span style="color: #6B90C0; font-style: italic">// authenticated token has the &quot;supervisor&quot; role:</span></span>
<span class="line" data-linenr="13"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">isSupervisor</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="15"><span style="color: #BBBBBB">    </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">TITLE_SUPERVISOR</span><span style="color: #999999">&#39;</span><span style="color: #999999">]</span></span>
<span class="line" data-linenr="16"><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span>
<span class="line" data-linenr="17"></span>
<span class="line" data-linenr="18"><span style="color: #6B90C0; font-style: italic">// If we add a custom voter, we would be able to i.e. test if we are</span></span>
<span class="line" data-linenr="19"><span style="color: #6B90C0; font-style: italic">// able to view a user&#39;s profile:</span></span>
<span class="line" data-linenr="20"><span style="color: #E5673D">$</span><span style="color: #D8DEE9">canViewProfile</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">=</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">accessDecisionManager</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">decide</span><span style="color: #999999">(</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #999999">,</span></span>
<span class="line" data-linenr="22"><span style="color: #BBBBBB">    </span><span style="color: #999999">[</span><span style="color: #999999">&#39;</span><span style="color: #7CC64A">VIEW</span><span style="color: #999999">&#39;</span><span style="color: #999999">],</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">    </span><span style="color: #E5673D">$</span><span style="color: #D8DEE9">authenticatedToken</span><span style="color: #E5673D">-&gt;</span><span style="color: #C7C8D2">getUser</span><span style="color: #999999">()</span><span style="color: #BBBBBB"> </span><span style="color: #6B90C0; font-style: italic">// some context for the &quot;view&quot; action</span></span>
<span class="line" data-linenr="24"><span style="color: #999999">)</span><span style="color: #E5673D">;</span></span></code></pre>
</div>

<h2 id="relation-with-the-symfony-framework">Relation with the Symfony Framework</h2>

<p>Now, if we take a look at the configuration for the SecurityBundle, we’ll find
many relations with the architecture used above:</p>

<div class="language-yaml highlighter-shiki"><pre class="shiki-gutter">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><pre class="shiki-code"><code><span class="line" data-linenr="1"><span style="color: #C7C8D2">security</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="2"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Providers: UserProvider classes</span></span>
<span class="line" data-linenr="3"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">providers</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="4"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">in_memory</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="5"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># indicating the InMemoryUserProvider</span></span>
<span class="line" data-linenr="6"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">memory</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">~</span></span>
<span class="line" data-linenr="7"></span>
<span class="line" data-linenr="8"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># The UserPasswordEncoders</span></span>
<span class="line" data-linenr="9"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">encoders</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="10"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">Symfony\Component\Security\Core\User\UserInterface</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">plaintext</span></span>
<span class="line" data-linenr="11"></span>
<span class="line" data-linenr="12"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Firewalls are listeners of the HTTP component that</span></span>
<span class="line" data-linenr="13"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># execute authentication based on paths</span></span>
<span class="line" data-linenr="14"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">firewalls</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="15"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># ...</span></span>
<span class="line" data-linenr="16"></span>
<span class="line" data-linenr="17"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># Each firewall configures a list of authentication providers</span></span>
<span class="line" data-linenr="18"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># used for this AuthenticationProviderManager. I.e. all</span></span>
<span class="line" data-linenr="19"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># firewalls are one AuthenticationProviderManager (and thus,</span></span>
<span class="line" data-linenr="20"><span style="color: #999999">        </span><span style="color: #6B90C0; font-style: italic"># one security system).</span></span>
<span class="line" data-linenr="21"><span style="color: #BBBBBB">        </span><span style="color: #C7C8D2">main</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="22"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># AnonymousAuthenticationProvider</span></span>
<span class="line" data-linenr="23"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">anonymous</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="24"></span>
<span class="line" data-linenr="25"><span style="color: #999999">            </span><span style="color: #6B90C0; font-style: italic"># Use UsernamePasswordToken and DaoAuthenticationProvider</span></span>
<span class="line" data-linenr="26"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">http_basic</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="27"><span style="color: #BBBBBB">            </span><span style="color: #C7C8D2">form_login</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #E5673D">true</span></span>
<span class="line" data-linenr="28"></span>
<span class="line" data-linenr="29"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># Relate to AccessDecisionManager#isGranted() calls for</span></span>
<span class="line" data-linenr="30"><span style="color: #999999">    </span><span style="color: #6B90C0; font-style: italic"># specific paths</span></span>
<span class="line" data-linenr="31"><span style="color: #BBBBBB">    </span><span style="color: #C7C8D2">access_control</span><span style="color: #999999">:</span></span>
<span class="line" data-linenr="32"><span style="color: #BBBBBB">        </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">path</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">^/admin</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">roles</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">ROLE_ADMIN</span><span style="color: #BBBBBB"> </span><span style="color: #999999">}</span></span>
<span class="line" data-linenr="33"><span style="color: #BBBBBB">        </span><span style="color: #999999">-</span><span style="color: #BBBBBB"> </span><span style="color: #999999">{</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">path</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">^/profile</span><span style="color: #999999">,</span><span style="color: #BBBBBB"> </span><span style="color: #C7C8D2">roles</span><span style="color: #999999">:</span><span style="color: #BBBBBB"> </span><span style="color: #7CC64A">ROLE_USER</span><span style="color: #BBBBBB"> </span><span style="color: #999999">}</span></span></code></pre>
</div>

<h2 id="take-homes">Take Home’s</h2>

<p>I hope this posts has provided you some insights in how the Security component
works.</p>

<ul>
  <li>Security HTTP is only a small layer converting HTTP requests into input for
the Security system</li>
  <li>There are many similarities between the config in the Symfony framework and
the workings of the Security Core component</li>
  <li>A complete working implementation of the Security component can be achieved
in 20 lines of PHP</li>
</ul>

<p>In this posts, you might have also observed some weird things. I’ll go into
further detail on them in later posts.</p>

<ul>
  <li>There is no build-in authorization for API tokens</li>
  <li>The token representing user input is the same as the authenticated token</li>
  <li>Authorization by default is on the <em>identity</em> rather than the <em>action</em></li>
</ul>]]></content><author><name>Wouter de Jong</name></author><category term="article" /><category term="symfony" /><category term="security" /><summary type="html"><![CDATA[Setting up big Symfony components in a blank PHP project helps a lot to understand it. You’ll grasp the main architecture of the component much easier this way. Let’s try to understand Symfony Security by doing exactly this!]]></summary></entry></feed>